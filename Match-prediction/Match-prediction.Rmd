---
title: "Predicting match results in professional tennis"
author:
- familyname: HE
  othernames: XITONG
  address: Monash University
  email: xhee0013@student.monash.edu
  correspondingauthor: true
  qualifications: 29026342
department: Department of\newline Econometrics &\newline Business Statistics
organization: ETC5543 Internship Project
bibliography: references.bib
biblio-style: authoryear-comp
linestretch: 1.5
output:
  MonashEBSTemplates::report:
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    includes:
      in_header: preamble.tex
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, message=FALSE, warning=FALSE)

library(tidyverse)
library(dplyr)
library(ggplot2)
library(here)
library(kableExtra)
library(wordcloud2)
library(ggrepel)
library(RColorBrewer)
library(scales)
library(formattable) 
```


```{r read-data}
atp_results<-readRDS(here("data/atp_results.rds"))%>%
    filter(Retired!="TRUE",Walkover!="TRUE")
wta_results<-readRDS(here("data/wta_results.rds"))%>%
    filter(Retired!="TRUE",Walkover!="TRUE")
atp_results%>%
  select(ID1,ID2,Player1,Player2,Surface,Tier)->atp_matches
atp_matches$h2hid<-paste0(atp_matches$ID1, 
                      ':', atp_matches$ID2 )
atp_matches$matches<-paste0(atp_matches$Player1, 
                      ':', atp_matches$Player2)

wta_results%>%
  select(ID1,ID2,Player1,Player2,Surface,Tier)->wta_matches
wta_matches$h2hid<-paste0(wta_matches$ID1, 
                      ':', wta_matches$ID2 )
wta_matches$matches<-paste0(wta_matches$Player1, 
                      ':', wta_matches$Player2)
```

# Introduction

In recent years, in order to meet the needs of sport coaches or media industry, the application of statistical analysis in the field of sports has developed rapidly. The ability to accurately predict the outcome of sporting matches is gaining popularity. For example, sport matches forecasting could allow media channels to provide more in-depth coverage of sporting events or allow tournament organizers to better match players' skills to provide closer, more exciting matches. Tennis is one of the appealing sports chosen in this project. The purpose of this project is to study the performance of different prediction methods in men's and women's professional tennis matches. The measure is used to build up the prediction model based on historical data in the last decay. This project examines several probabilistic models for forecasting the outcomes of professional tennis levels such as ATP or WTA matches. These models not only focus on the prediction results in the tennis matched, but also consider the head to head effect where would affect the performance in some players. In addition, the effects of surface type and the variation between players such as head-to-head effect would be addressed in the models as one of the exploratory variables and random effect variables. The models are trained and evaluated on the two historical tennis matches results of approximately 38,000 tennis matches between 2010 and 2020. 

# The motivation of this project

The main objective of the project is to develop and evaluate different approaches for predicting the tennis match results. In addition, by considering the head to head effects which might exist in the matches, this project would investigate strategies for estimating and incorporating these matchup effects into a prediction model.


# Data description {#data}

This section mainly introduces the data, data sources and data description.   

There are two data sets used on this analysis report, and both of them are obtained from [GitHub skoval](https://github.com/skoval/monash-match-wins), which have similar data structures.  


## ATP_results

The `atp_results` data source is from [Github skoval](https://github.com/skoval/monash-match-wins). The data contains the ATP tour results in the last decay, which is a worldwide top-tier tennis tour for men organized by the Association of Tennis Professionals, with `r nrow(atp_results)` observations and `r ncol(atp_results)`variables from 2011-01-01 to 2020-01-23.   

The variables information included in the data are shown as the following table, Players, Surface,MatchID and Tier variables were mainly used for this analysis.    

```{r atp-data, warning=FALSE, message=FALSE}
atp_data <- data.frame(
  Variable = c("ID1","ID2","ID_T","ID_R","RESULT","DATE","NAME_T","DATE_T","Surface","Player1","Player2","Retired","Walkover","Qualifying","MatchID","Tier"),
  Description = c("Winner ID", "Loser ID","Terminology ID","The around in tennis match","Matches games results","Match Date","Name of the match","Date of tennis tourments","Match Surface","Match Winner","Match Loser","withdrawal of a player during a match, usually due to injury and illness","victory awarded to a player when their opponent concedes a match before it begins, usually due to injury or illness","preliminary event that offers players whose rankings don’t gain them direct entry in the main draw of a tournament, the opportunity to win a spot in that main draw","Unique ID for each match","collective term referring to the group of matches or rubbers played between two teams in a team tennis even"
  ))

atp_data %>%
  kable(caption = "Association of Tennis Professionals") %>%
  kable_styling(bootstrap_options = 
                c("striped", "condensed"), 
                full_width = F, 
                position = "center")
```


 
## WTA data

The `wta_results`data was gathered from [Github skoval](https://github.com/skoval/monash-match-wins) as well, of which is recorded the worldwide professional tennis tour match results for women. This dataset contains `r nrow(wta_results)` observation and `r ncol(wta_results)` variables from 2011-01-01 to 2020-01-23 and the data structure is shown as the below tables: 

```{r wta-data, warning=FALSE, message=FALSE}
wta_data <- data.frame(
  Variable = c("ID1","ID2","ID_T","ID_R","RESULT","DATE","NAME_T","DATE_T","Surface","Player1","Player2","Retired","Walkover","Qualifying","MatchID","Tier"),
  Description = c("Winner ID", "Loser ID","Terminology ID","The around in tennis match","Matches games results","Match Date","Name of the match","Date of tennis tourments","Match Surface","Match Winner","Match Loser","withdrawal of a player during a match, usually due to injury and illness","victory awarded to a player when their opponent concedes a match before it begins, usually due to injury or illness","preliminary event that offers players whose rankings don’t gain them direct entry in the main draw of a tournament, the opportunity to win a spot in that main draw","Unique ID for each match","collective term referring to the group of matches or rubbers played between two teams in a team tennis even"
  ))

wta_data %>%
  kable(caption = "Women’s Tennis Association Tour") %>%
  kable_styling(bootstrap_options = 
                c("striped", "condensed"), 
                full_width = F, 
                position = "center")
```

# Head to Head effect Analysis

Head to head means the direct competition between two players. In this project, head-to-head effect indicates that the matchup effect of two specific players meeting in the matches. This is not only to consider the player's ability in tennis skills such as the talented-levels, but more importantly to detect whether there is a certain effect between the two players such as one player might have over a specific opponent that goes beyond what their ability would predict, factors like style or psychological impact.

```{r male-win-most-of-matches,fig.cap="Most of games in male athlete "}

#Use the words cloud to briefly introduce who has won the most of matches in her/his career, which the total matches for players are above 150
atp_winner_freq<-atp_matches%>%
  group_by(Player1)%>%
  summarise(freq= n())%>%
  arrange(desc(freq))%>%
  filter(freq>=150)%>%ungroup

pal <- brewer.pal(8, "Dark2")

wordcloud::wordcloud(words = atp_winner_freq$Player1, freq =atp_winner_freq$freq,
          scale=c(1.6,0.01),random.order=T, colors=pal, vfont=c("sans serif","plain"))

```

```{r female-win-most-of-matches,fig.cap="Most of games in female athlete }
wta_winner_freq<-wta_matches%>%
  group_by(Player1)%>%
  summarise(freq= n())%>%
  arrange(desc(freq))%>%
  filter(freq>=150)%>%ungroup
wordcloud::wordcloud(words = wta_winner_freq$Player1, freq =wta_winner_freq$freq,
          scale=c(1.4,0.01),random.order=T, colors=pal, vfont=c("sans serif","plain"))

```


The figure \@ref(fig:male-win-most-of-matches) and the figure \@ref(fig:female-win-most-of-matches) show the male and female players who have won more than 150 games are in the last ten years. Novak Djokovic, as the current number one male player in the world rankings, has won more than 500 matches over the past last decay, and Roger Ferrer and Rafael Nadal who are the current top 10 players in the world, winning more than 450 matches. On the other hand, Caroline Wozniacki was the top 1 female players between 2010 and 2012, has won more than 370 matches in the last ten year. 

## Evaluating the head to head effect in each tier

However, tennis sports is like a pyramid, with the size of the competitive pool getting lower when the players go upward the tournament tier as the stronger players will stay until the end. In this case,if there are many cases of player-opponent matchups with a single match, this will affect the accuracy of estimations of the head-to-head effects and bring all the effects closer to zero that would be the case with a less sparse sample. Therefore, based on the table \@ref(tab:atp_tier_summary),having played more than 3 matches against an opponent is an unusually long history compared to the normal matches. In the `atp` data, there are four tier groups and ATP WorldTour 250 has most of matches records which is the lowest tier of annual men's tennis tournaments on the main ATP Tour. The player-opponent with more than 2 matches only  Matches with more than two matches against the same opponent accounted for 7.81 percent of the ATP WorldTour 250, and only 3.76 percent with more than three matches. It is obviously that the number of matches against the same opponent will be less and less in each tier especially in ATP WorldTour 250. A similar situation occurs in `wta` data. The table \@ref(tab:wta_tier_summary) shows that less than 10% chance of playing more than 2 or 3 games against the same opponent in all tiers. It is worth noting that WTA Tour will rename its tournaments in 2021 which will simplify the understanding of the structure of the tour. Therefore, the premier category become WTA 1000s and 500s and international category become WTA 250s, much like the ATP tour tournaments. In addition, 125K serier is like the challenger level in ATP which is the entry-level for tour tournaments. But from the table data, the number of matches occurred in the 125K Series is the lowest, suggesting that players at the 125K Series will not often build up substantial head-to-heads against other players on the tour. According to the data from these two tables, it indicates that head-to-head matches are infrequent and that the number of matches in each tier that involve player-opponent matchup effects in the long history is very small.

```{r atp_tier_summary,fig.cap="Matches of head to head effect on each tier in ATP"}

#calculate the percentage of h2h matches in each tier for atp results

# atp_results%>%
#   group_by(Player1,Player2,Tier)%>%
#   count()%>%
#   group_by(Tier)%>%
#   summarise(n=sum(n))%>%
#   ungroup->atp_tier
# atp_tier
# 
# 
# atp_tier_summary<-atp_tier%>%
#   mutate(total=sum(n),
#          `prop`=n/total,
#          per=percent(prop))
atp_long%>%group_by(h2hid,Tier)%>%tally()%>%mutate(count=n/2)%>%select(-n)%>%ungroup()%>%filter(count>=3)%>%group_by(Tier)%>%summarise(`matches>=3`=sum(count))%>%
  left_join(atp_long%>%group_by(h2hid,Tier)%>%tally()%>%mutate(count=n/2)%>%select(-n)%>%ungroup()%>%filter(count==2)%>%group_by(Tier)%>%summarise(`matches=2`=sum(count)))%>%
  left_join(atp_long%>%group_by(h2hid,Tier)%>%tally()%>%mutate(count=n/2)%>%select(-n)%>%ungroup()%>% group_by(Tier)%>%summarise(total=sum(count)))%>%
  mutate(`per(match>=3)`=percent(`matches>=3`/sum(total)),
         `per(match=2)`=percent(`matches=2`/sum(total)))->atp_tier

out = as.htmlwidget(formattable(atp_tier,
            list(`per(match>=3)` = color_bar("#BDD9EC"),
                `per(match=2)` = color_bar("#FA614B") )))
out$dependencies = c(out$dependencies, htmlwidgets:::widget_dependencies("sparkline", "sparkline"))
out 
```

```{r atp_tier_summary,fig.cap="Matches of head to head effect on each tier in WTA"}
wta_long%>%group_by(h2hid,Tier)%>%tally()%>%mutate(count=n/2)%>%select(-n)%>%ungroup()%>%filter(count>=3)%>%group_by(Tier)%>%summarise(`matches>=3`=sum(count))%>%
  left_join(wta_long%>%group_by(h2hid,Tier)%>%tally()%>%mutate(count=n/2)%>%select(-n)%>%ungroup()%>%filter(count==2)%>%group_by(Tier)%>%summarise(`matches=2`=sum(count)))%>%
  left_join(wta_long%>%group_by(h2hid,Tier)%>%tally()%>%mutate(count=n/2)%>%select(-n)%>%ungroup()%>% group_by(Tier)%>%summarise(total=sum(count)))%>%
  mutate(`per(match>=3)`=percent(`matches>=3`/sum(total)),
         `per(match=2)`=percent(`matches=2`/sum(total)))->wta_tier

out = as.htmlwidget(formattable(wta_tier,
            list(`per(match>=3)` = color_bar("#BDD9EC"),
                `per(match=2)` = color_bar("#FA614B") )))
out$dependencies = c(out$dependencies, htmlwidgets:::widget_dependencies("sparkline", "sparkline"))
out 
```

## Evaluating the H2H effect in each surface

(explore the percentage of occurring head to head matches in different three tiers )

```{r surface_summary,fig.cap="Matches of head to head effect on three types of surface"}

#calculate the percentage of h2h matches in each surface for atp results

atp_results%>%
  group_by(Player1,Player2,Surface)%>%
  count()%>%
  group_by(Surface)%>%
  summarise(n=sum(n))%>%
  ungroup->atp_surface


atp_surface_summary<-atp_surface%>%
  mutate(total=sum(n),
         `prop`=n/total,
         per=percent(prop))

out = as.htmlwidget(formattable(atp_surface_summary,
            list(`per` = color_bar("#FA614B"))))
out$dependencies = c(out$dependencies, htmlwidgets:::widget_dependencies("sparkline", "sparkline"))
out
```


## Calculating the head to head effect on win odds for each matches

(summarize the total matches of each pair players, and calculating the winners odd who has won most of matches between two players)


```{r long-format-matches}
# tidy up the data(rename and select variables)
atp_results%>%
  select(ID1,ID2,Player1,Player2,Surface,Tier)%>%
  mutate(h2hid=paste0(ID1, ':', ID2),
         matches=paste0(Player1, ':', Player2))->atp_matches


# Make long format by stacking winners and losers
atp_long <- rbind(
	atp_results %>% filter(Retired!="TRUE",Walkover!="TRUE")%>% dplyr::select(playerid = ID1, opponentid = ID2, ID_T, ID_R, DATE, Surface, player = Player1, MatchID, Tier) %>% dplyr::mutate(matchwin = TRUE),
	atp_results %>% filter(Retired!="TRUE",Walkover!="TRUE")%>%
	  dplyr::select(playerid = ID2, opponentid = ID1, ID_T, ID_R, DATE, Surface, player = Player2, MatchID, Tier) %>% dplyr::mutate(matchwin = FALSE)
)

head_to_head <- function(id1, id2){
	# assign h2h idea 
	ifelse(id1 > id2, paste(id1, id2, sep = ":"), paste(id2, id1, sep = ":"))
}

atp_long <- atp_long %>%
	dplyr::mutate(
		h2hid = head_to_head(playerid, opponentid)
	)
```


```{r calculating the prob}
atp_h2h_match<-atp_matches%>%
  group_by(h2hid,Player1,Player2)%>%
  tally()%>%
  ungroup(h2hid)

#use the atp_long data set to calculate the total number of each pair players where they met
atp_h2h_count<-atp_long%>%
  group_by(h2hid)%>%
  tally()%>%
  mutate(total_count=n/2)%>%
  select(-n)%>%
  ungroup()

#calculate the win probability and lose probability for each pair players in terms of total number of the matches
match_count<-left_join(atp_h2h_match,atp_h2h_count,by="h2hid")%>%
  drop_na()%>%#drop na since some of data are included in the total matches of each pair palyers but only different in winning players
  rename(p1_count=n)%>%
  mutate(p2_count=round(total_count-p1_count,3),
         prob_p1_win=round(p1_count/total_count,3),
         prob_p2_win=round(p2_count/total_count,3))
```

# Model analysis


## Pairwise Comparison Models
Pairwise comparison is the process of comparing entities in pairs to determine which one has a better chance of winning. One of the famous method for establishing pairwise comparison is Bradley Terry Model[@bradley1952rank], applying in the contest between two players.

Let $$y_{ij,t}$$ be the outcome of a tennis match that is played between player i and player j at time t. We assume that we have information about K different players over a time period of length n, i.e. i, j =1.... ,K and t =1..., n. The outcome $${y_{ij,t} =1}$$ if player i wins the match at time t whereas the outcome $${y_{ij,t} =0}$$  if player j wins the match at time t. Therefore, the outcomes about $$y_{ij,t}$$ are binary response value.

The conditional probability that yij,t =1 is given by 
$$Pij,t=P(y_{ij,t}=1|\delta_{ij,t})=\frac{exp(\delta_{ij,t})}{1+exp(\delta_{ij,t})}$$ , $$\delta_{ij,t}=\lambda_{i,j}-\lambda_{j,t}$$
where$$\lambda_{i,t}$$ represents the skill level of player i at time t and $$\lambda_{j,t}$$ represents the skill level
of player j at time t. The conditional probability of $${y_{ij,t} =0}$$ is instead equal to$$1-P_{ij,t}$$.

On the other hand, this model can be alternatively expressed in the following logit-linear way, which can be reduce the model to logistics regression on pairs of individuals:
$$logit[P(i beats j)]=logit(P(i>j))=log(\frac{P(i>j)}{1-P(i>j)})=\lambda_{i}-\lambda_{j}$$
where $$\lambda_{i}$$ =$$log\alpha_{i}$$ for all i and it can be . Based on the i.i.d(independent identifying distributed) assumption for all contests[@klaassen2001points],the parameters $$\lambda_{i}$$ can be estimated by maximum likelihood using `BradleyTerry2` package[@bradley] for generalized linear models. The `BradleyTerry2` package provides a more flexible user interface to allow a wider range of models to be fitted in the data and allows the inclusion of simple random effects, where the $$ \lambda_{i}$$ can be related to explanatory variable via a linear predictor of the form:
$$\lambda_{i}=\sum_{r=1}^{p}{\beta_{r}x_{ir}+U_{i}}$$

The inclusion of the prediction error $$U_i$$ allows for variability between players with equal covariate values and induces correlation between comparisons with a common player. 

```{r convert-factor-same-levels}
# tidy up new matches data and convert the two factors for players into same level in terms of building the model
# remove the ties from two players
match_count%>%
  select(Player1,Player2,p1_count,p2_count)%>%
  filter(p1_count!=p2_count)%>%
  mutate(Player1 = factor(Player1, levels = unique(c(Player1, Player2))),
         Player2= factor(Player2, levels = levels(Player1)))->match
```


```{r simple-BT-model}
#the coefficients are maximum likelihood estimates of lambda n with lambda1( the log-ability for Tomislav Brkic) set to zero as identifying convention

#~player specifies the model for player ability, in this case it stands for ‘tennis capability’ 
model1<-BTm(cbind(p1_count,p2_count),Player1,Player2,~Player,id="Player",data = match)

#summary(model1)
```


```{r p-value}
ll.null<-model1$null.deviance/-2
ll.proposed<-model1$deviance/-2
(ll.null-ll.proposed)/ll.null
1-pchisq(2*(ll.proposed-ll.null),df=(length(model1$coefficients)-1))
#The p-value is extremely small, so we can safely reject the null hypothesis that there is no head to head effect advantage.

#Since the dispersion parameter is 1, where is the variance derived from the mean, so the model is suitable as it did not underestimated


# construct the coefficient data frame and read the coeffienct in convenient way
ability<-BTabilities(model1)
ability<-data.frame(Player=rownames(ability),
                    Ability=ability[,1],
                    SE=ability[,2])
ability$Player<-factor(ability$Player,
                       levels = ability$Player[order(ability$Ability)],
                       ordered = T)

```


```{r ceof-BT-model}
#coefficient for simple BT model without ties
result<-read.csv(here("data/ability_no_ties.csv"))


player1<-match$Player1
player2<-match$Player2
match_count<-match_count%>%
  filter(p1_count!=p2_count)
#Calculate odds of Team1 beating Team2 is (Team1/Team2)/(Team1/Team2 + 1)
match_count$player1_Odds <- as.numeric(unlist(result[match(player1, result[, 1]),][2]))

match_count$player2_Odds <- as.numeric(unlist(result[match(player2, result[, 1]),][2]))

match_count <- match_count%>%
  mutate(exp_p1_win=as.numeric(unlist(exp(player1_Odds-player2_Odds)/(1+exp(player1_Odds-player2_Odds)))),
         diff=prob_p1_win-exp_p1_win)%>%
  select(h2hid,Player1,Player2,exp_p1_win,prob_p1_win)%>%
  mutate(outcome=as.numeric(prob_p1_win<0.5),
         exp_p1_win=replace(exp_p1_win,exp_p1_win==1,0.99))

library(givitiR)
cb1 <- givitiCalibrationBelt(o = match_count$outcome, e = match_count$exp_p1_win,
                             devel = "external")
plot(cb1, main = "Bradley Terry calibration",
     xlab = "Bradley Terry predicted probability",
     ylab = "Observed mortality")


```

## Bayesian Paired Comparison models in Stan

**Simple Bradley Terry model: **

The `bpcs` package utilizes normal priors for the $$\lambda$$ parameters and models the outcome variable $$y_{i,j}$$ of a single contest between players i and j with a Bernoulli distribution, based on the probability of winning for $$\mathrm{P}(\left[ i \mbox{ beats } j \right]$$.

The simple Bayesian Bradley Terry Model is:

$$\mathrm{P}(\left[ i \mbox{ beats } j \right]=\frac{exp(\lambda_{i})}{exp(\lambda_{i})+exp(\lambda_{j})}=\lambda_{i}-\lambda_{j}$$

where $$y_{ij}\sim Bernoulli(p[i beats j])$$; $$ \lambda_{i} \sim N(0,\sigma_{\lambda}^2),[Prior]$$

The parameters $$ \lambda_{i}$$ can be used to rank the different players. However, in the Bayesian framework, a single measure is not obtained but rather a posterior distribution of the parameters $$ \lambda_{i}$$. By sampling from the posterior distribution of the log-abilities of the players, it is possible to create a posterior distribution of the ranks of the players, which helps to evaluate the uncertainty in the ranking system.

**Davidson Model: **

Ties refer to the case where a subject does not express a preference for a player in a contest. Therefore, **Davidson model** would be introduced to handle ties in the contest between two players, which adds an additional parameter$$\upsilon$$ and computes two probabilities: the probability of i beating j given that it was not a tie $$ P[i beats j|not tie] $$and the probability of the result being a tie $$P[i ties j]$$. A Bayesian formulation of the model is represented below:

$$\mathrm{P}(\left[ i \mbox{ beats } j \right]
|  \mbox{ not tie })=\frac{exp(\lambda_{i})}{exp(\lambda_{i})+exp(\lambda_{j})+exp(\upsilon+\frac{\lambda_{i}+\lambda_{j}}{2})}$$;
$$\mathrm{Pr}\left[ i \mbox{ beats } j \right]
=\frac{exp(\upsilon+\frac{\lambda_{i}+\lambda_{j}}{2})}{exp(\lambda_{i})+exp(\lambda_{j})+exp(\upsilon+\frac{\lambda_{i}+\lambda_{j}}{2})}$$;
$$y_{ij}\sim Bernoulli(\mathrm{P}\left[ i \mbox{ beats } j \right]| \mbox{ not tie })$$;
$$tie_{i,j} \sim Bernoulli(\mathrm{P}\left[ i \mbox{ ties } j \right])$$;
$$ \lambda_{i} \sim N(0,\sigma_{\lambda}^2),[Prior]$$;
$$\upsilon \sim N(0,\sigma_{\lambda}^2),[Prior]$$

where the choice of prior in $$\upsilon$$ parameter refers to the prior belief on how ties are affected by the relative difference in players’ abilities.

```{r construct-bpc_data}
atp_surface<-atp_matches%>%
  group_by(h2hid,Winner,Loser,Surface)%>%
  tally()%>%
  ungroup()%>%
  pivot_wider(names_from = Surface,
              values_from=n,
              values_fill=0)
atp_long%>%
  group_by(h2hid,Surface)%>%
  tally()%>%
  mutate(total_count=n/2)%>%
  select(-n)%>%
  ungroup()%>%
   pivot_wider(names_from = Surface,
              values_from=total_count,
              values_fill=0)->h2h_surface_atp

atp_surface%>%
  rename(p1_clay=Clay,
         p1_grass=Grass,
         p1_hard=Hard)%>%
  left_join(h2h_surface_atp,by="h2hid")%>%
  mutate(p2_clay=Clay-p1_clay,
         p2_grass=Grass-p1_grass,
         p2_hard=Hard-p1_hard,
         p1_clay=as.numeric(p1_clay),
         p1_grass=as.numeric(p1_grass),
         p1_hard=as.numeric(p1_hard))%>%
  drop_na()%>%
  select(-Clay,-Grass,-Hard)->surface

surface%>%
  rename(player1=Winner,player2=Loser)%>%
  select(player1,player2,p1_clay,p2_clay)%>%
  mutate(Type=paste("Clay"))%>%
  rename(p1_count=p1_clay,
         p2_count=p2_clay)->clay

surface%>%
  rename(player1=Winner,player2=Loser)%>%
  select(player1,player2,p1_grass,p2_grass)%>%
  mutate(Type=paste("Grass"))%>%
  rename(p1_count=p1_grass,
         p2_count=p2_grass)->grass

surface%>%
  rename(player1=Winner,player2=Loser)%>%
  select(player1,player2,p1_hard,p2_hard)%>%
  mutate(Type=paste("Hard"))%>%
  rename(p1_count=p1_hard,
         p2_count=p2_hard)->hard

clay%>%
  rbind(hard)%>%
  rbind(grass)->bpcs_data
bpcs_data%>%
   arrange(desc(p1_count))%>%
  head(1000)%>%
  na.omit()%>%
  mutate(player1=as.character(player1),
         player2=as.character(player2))->bpcs_sample
```


```{r bpc-BT-model}
library(bpcs)
library(cmdstanr)
mod1 <- bpc(data = bpcs_sample,
          player0 = 'player1',
          player1 = 'player2',
         player0_score = "p1_count",
         player1_score = "p2_count",
          model_type = 'bt',
         solve_ties = 'random',
           priors = list(prior_lambda_std = 2.0),
            iter = 3000)
mod2 <- bpc(data = bpcs_sample,
          player0 = 'player1',
          player1 = 'player2',
         player0_score = "p1_count",
         player1_score = "p2_count",
          model_type = 'davidson',
          solve_ties = 'none', #there are no ties
          priors = list(prior_lambda_std = 2.0),
            iter = 3000)
```


**Mixed effect model in Stain (Surface random effect ): **

Böckenholt (2001) decomposed the paired comparison model into fixed and a random effect components. The random effects component estimates the subject variation (given S subjects) in each item, while the fixed effect component such as $$\lambda_{i,s}$$ and $$\lambda_{j,s}$$ estimates the average log ability of the player. The random effects term is represented by $$U_{i,s}$$, where i refers to the player being judged and s to the subject. The Bayesian Bradley-Terry model with random effects can be represented as:
$$\mathrm{Pr}\left[ i \mbox{ beats } j \right]=\frac{exp(\lambda_{i,s})}{exp(\lambda_{i,s})+exp(\lambda_{j,s})}$$;
$$\lambda_{i,s}=\lambda_{i}+U_{i,s}$$;

$$y_{ij}\sim Bernoulli(\mathrm{P}\left[ i \mbox{ beats } j \right])$$;
$$ \lambda_{i} \sim N(0,\sigma_{\lambda}^2),[Prior]$$;
$$ U_{i,s} \sim N(0,U_{std}^2),[Prior]$$;
$$ U_{std} \sim N(0,\sigma_{U}^2),[Prior]$$

In this case, $$s$$ represents different types of surface so $$U_{std}$$ represents the standard deviation in the random effects and the difference between subjects. Therefore, the surface variable should be the random intercept as the grouped variables to evaluate the ability of each players within different surfaces. By doing this way, added the surface as a benchmark to represent the matches in which each pair players on different field.

```{r mixed-effect}
mod3 <- bpc(data = bpcs_sample,
          player0 = 'player1',
          player1 = 'player2',
         player0_score = "p1_count",
         player1_score = "p2_count",
          model_type = 'bt-U',
         cluster = 'Type',
         solve_ties = 'random', 
          priors = list(prior_lambda_std = 2.0,prior_U1_std = 10.0),
            iter = 3000)
mod4 <- bpc(data = bpcs_sample,
          player0 = 'player1',
          player1 = 'player2',
         player0_score = "p1_count",
         player1_score = "p2_count",
          model_type = 'davidson-U',
         cluster = 'Type',
          solve_ties = 'none', #there are no ties
          priors = list(prior_lambda_std = 2.0,prior_U1_std = 10.0),
            iter = 3000)
```


```{r waic-value}
library(rstan)


m1_waic <-get_waic(mod1)
m2_waic <-get_waic(mod2)
m3_waic <-get_waic(mod3)
m4_waic<-get_waic(mod4)
m1_waic
m2_waic
m3_waic
m4_waic
loo::loo_compare(m1_waic,m2_waic,m3_waic, m4_waic)
```
