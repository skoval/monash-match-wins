---
title: "Predicting match results in professional tennis"
author: XITONG HE 
organization: ETC5543 Internship Project
bibliography: references.bib
biblio-style: authoryear-comp
linestretch: 1.5
output:
    bookdown::html_document2:
    theme: paper
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: false
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, message=FALSE, warning=FALSE)

library(tidyverse)
library(dplyr)
library(ggplot2)
library(here)
library(kableExtra)
library(wordcloud)
library(ggrepel)
library(RColorBrewer)
library(scales)
library(formattable) 
library(bpcs)
library(BradleyTerry2)
library(rvest)
library(rstan)
library(bayesplot)
library(ggpubr)
library(DT)
```


```{r read-data}
atp_results<-readRDS(here("data/atp_results.rds"))%>%
    filter(Retired!="TRUE",Walkover!="TRUE")
wta_results<-readRDS(here("data/wta_results.rds"))%>%
    filter(Retired!="TRUE",Walkover!="TRUE")

atp_results%>%
  select(Player1,Player2,Surface,Tier)%>%
  rename(player0=Player1,player1=Player2)->atp_results
wta_results%>%
  select(Player1,Player2,Surface,Tier)%>%
  rename(player0=Player1,player1=Player2)->wta_results


```

# Introduction

In recent years, in order to meet the needs of sport coaches or media industry, the application of statistical analysis in the field of sports has developed rapidly. The ability to accurately predict the outcome of sporting matches is gaining popularity. For example, sport matches forecasting could allow media channels to provide more in-depth coverage of sporting events or allow tournament organizers to better match players' skills to provide closer, more exciting matches. Tennis is one of the appealing sports chosen in this project. The purpose of this project is to study the performance of different prediction methods in men's and women's professional tennis matches. The measure is used to build up the prediction model based on historical data in the last decay. This project examines several probabilistic models for forecasting the outcomes of professional tennis levels such as ATP or WTA matches. These models not only focus on the prediction results in the tennis matched, but also consider the head to head effect where would affect the performance in some players. In addition, the effects of surface type and the variation between players such as head-to-head effect would be addressed in the models as one of the exploratory variables and random effect variables. The models are trained and evaluated on the two historical tennis matches results of approximately 4000 tennis matches between 2010 and 2020 after filtering top 100 players. 

# The motivation of this project

The main objective of the project is to develop and evaluate different approaches for predicting the tennis match results. In addition, by considering the head to head effects which might exist in the matches, this project would investigate strategies for estimating and incorporating these matchup effects into a prediction model.


# Data description {#data}


There are two data sets such as `atp_results` and `wta_results`used on this analysis report, and the two data sets consist of approximately 36,000 matches information from 2011-01-01 to 2020-01-23 in ATP tour and WTA tour. Both of them are obtained from [GitHub skoval](https://github.com/skoval/monash-match-wins), which have similar data structures. 
The table \@ref(tab:data-structure) summarises the key information which is contained about each match in the data. The data sets also contain further side information such as player id, date of tennis tournaments, Name of the match, the around in tennis match and ect. The full list is omitted as none of this additional information is used by the models in this project. So, the only four key variable were mainly used for this project. Theoretically, the full data sets should be used for data modeling but the ranking data about top 100 players in ATP or WTA will be introduced in the following section and combined them with the full data to construct the new model data which is used for the data modeling in this project report due to the system operation problem.


```{r data-structure, warning=FALSE, message=FALSE}
data <- data.frame(
  Variable = c("Surface","Player1","Player2","Tier"),
  Description = c("Match Surface","Match Winner","Match Loser","Collective term referring to the group of matches or rubbers played between two teams in a team tennis even" ))

data %>%
  kable(caption = "Key match informatiom") %>%
  kable_styling(bootstrap_options = 
                c("striped", "condensed"), 
                full_width = F, 
                position = "center")
```





# Head to Head effect Analysis

Head to head means the direct competition between two players. In this project, head-to-head effect indicates that the matchup effect of two specific players meeting in the matches. This is not only to consider the player's ability in tennis skills such as the talented-levels, but more importantly to detect whether there is a certain effect between the two players such as one player might have over a specific opponent that goes beyond what their ability would predict, factors like style or psychological impact.

```{r atp-most,fig.cap="The players won more than 200 matches in ATP"}

#Use the words cloud to briefly introduce who has won the most of matches in her/his career, which the total matches for players are above 200
atp_winner_freq<-atp_results%>%
  group_by(player0)%>%
  summarise(freq= n())%>%
  arrange(desc(freq))%>%
  filter(freq>=200)%>%ungroup

pal <- brewer.pal(8, "Dark2")

wordcloud::wordcloud(words = atp_winner_freq$player0, freq =atp_winner_freq$freq,
          scale=c(1.3,0.5),random.order=T, colors=pal, vfont=c("sans serif","plain"))

```

```{r wta-most,fig.cap="The players won more than 200 matches in WTA" }
wta_winner_freq<-wta_results%>%
  group_by(player0)%>%
  summarise(freq= n())%>%
  arrange(desc(freq))%>%
  filter(freq>=200)%>%ungroup
wordcloud::wordcloud(words = wta_winner_freq$player0, freq =wta_winner_freq$freq,
          scale=c(1,0.5),random.order=T, colors=pal, vfont=c("sans serif","plain"))

```


The figure \@ref(fig:atp-most) and the figure \@ref(fig:wta-most) show the male and female players who have won more than 200 matches are in the last ten years. Novak Djokovic, as the current number one male player in the world rankings, has won more than 500 matches over the past last decay, and Roger Ferrer and Rafael Nadal who are the current top 10 players in the world, winning more than 450 matches. On the other hand, Caroline Wozniacki was the top 1 female players between 2010 and 2012, has won more than 370 matches in the last ten years. 

## Evaluating the head to head effect in each tier

```{r}
atp_results%>%
	dplyr::mutate(
		Player0 = ifelse(player0 <= player1, player0, player1), # Make player0 first alphabetically
		Player1 = ifelse(player0 <= player1, player1, player0)
	) ->atp_results
wta_results%>%
	dplyr::mutate(
		Player0 = ifelse(player0 <= player1, player0, player1), # Make player0 first alphabetically
		Player1 = ifelse(player0 <= player1, player1, player0)
	) ->wta_results


tier_count<-function(data,player0,player1,Tier){
  data%>%
    dplyr::group_by(player0,player1,Tier)%>%
    dplyr::summarise(n = n(),y = sum(Player0 == player0),.groups = "drop"	)
}
surface_count<-function(data,player0,player1,Surface){
  data%>%
    dplyr::group_by(player0,player1,Surface)%>%
    dplyr::summarise(n = n(),y = sum(Player0 == player0),.groups = "drop"	)
  }
```



However, tennis sports is like a pyramid, with the size of the competitive pool getting lower when the players go upward the tournament tier as the stronger players will stay until the end. In this case,if there are many cases of player-opponent matchups with a single match, this will affect the accuracy of estimations of the head-to-head effects and bring all the effects closer to zero that would be the case with a less sparse sample. 

Therefore, from the table \@ref(fig:atp-tier),having played more than 3 matches against an opponent is an unusually long history compared to the normal matches. In the `atp` data, there are four tier groups and ATP WorldTour 250 has most of matches records which is the lowest tier of annual men's tennis tournaments on the main ATP Tour. The player-opponent with more than 3 matches accounted for 33.28 percent in the ATP WorldTour 250, and 40.75 in the Matser1000. It is obviously that the number of matches against the same opponent will be less and less in each tier especially in ATP WorldTour 500. A similar situation occurs in `wta` data.

Based on the table \@ref(fig:wta-tier) shows that less than chance of playing more than 2 or 3 games against the same opponent happened in all tiers. It is worth noting that WTA Tour will rename its tournaments in 2021 which will simplify the understanding of the structure of the tour. Therefore, the premier category become WTA 1000s and 500s and international category become WTA 250s, much like the ATP tour tournaments. In addition, 125K serier is like the challenger level in ATP which is the entry-level for tour tournaments. But from the table data, the number of matches occurred in the 125K Series is the lowest, suggesting that players at the 125K Series will not often build up substantial head-to-heads against other players on the tour. According to the data from these two tables, it indicates that head-to-head matches are infrequent and that the number of matches in each tier that involve player-opponent matchup effects in the long history is very small.



```{r atp-tier,fig.cap="The number macthes with h2h effect in each tier in ATP"}
tier_count(atp_results,player0,player1,Tier)%>%
  group_by(Tier)%>%summarise(`match`=sum(n))%>%
  left_join(tier_count(atp_results,player0,player1,Tier)%>%
              filter(n==2)%>%group_by(Tier)%>%summarise(`match`=sum(n)),by=c('Tier'='Tier'))%>%
   left_join(tier_count(atp_results,player0,player1,Tier)%>%
              filter(n>=3)%>%group_by(Tier)%>%summarise(`match`=sum(n)),by=c('Tier'='Tier'))%>%
  rename(match=match.x,
         `match=2`=match.y,
         `match>=3`=match)%>%
  mutate(`per(match>=3)`=percent(`match>=3`/sum(`match>=3`)))->atp_tier

atp_tier_out = as.htmlwidget(formattable(atp_tier,
            list(`per(match>=3)` = color_bar("#BDD9EC"))))
                # `per(match=2)` = color_bar("#FA614B") )))
atp_tier_out $dependencies = c(atp_tier_out $dependencies, htmlwidgets:::widget_dependencies("sparkline", "sparkline"))
atp_tier_out 
```

```{r wta-tier,fig.cap="The number macthes with h2h effect in each tier in ATP"}
tier_count(wta_results,player0,player1,Tier)%>%
  group_by(Tier)%>%summarise(`match`=sum(n))%>%
  left_join(tier_count(wta_results,player0,player1,Tier)%>%
              filter(n==2)%>%group_by(Tier)%>%summarise(`match`=sum(n)),by=c('Tier'='Tier'))%>%
   left_join(tier_count(wta_results,player0,player1,Tier)%>%
              filter(n>=3)%>%group_by(Tier)%>%summarise(`match`=sum(n)),by=c('Tier'='Tier'))%>%
  rename(match=match.x,
         `match=2`=match.y,
         `match>=3`=match)%>%
  mutate(`per(match>=3)`=percent(`match>=3`/sum(`match>=3`)))->wta_tier

wta_tier_out  = as.htmlwidget(formattable(wta_tier,
            list(`per(match>=3)` = color_bar("#BDD9EC"))))
                # `per(match=2)` = color_bar("#FA614B") )))
wta_tier_out$dependencies = c(wta_tier_out$dependencies, htmlwidgets:::widget_dependencies("sparkline", "sparkline"))
wta_tier_out
```

## Evaluating the H2H effect in each surface

Similarly, the table \@ref(fig:atp-surface) and \@ref(fig:wta-surface) represent the number of tennis matches occurred in different surface type in the last decay. Obviously, the majority of matches, and even matchups more than three times, take place on hard courts, where movement tends to be medium to fast because the court absorbs little energy and players are able to use a variety of spins during the match. In addition, Clay court is the second highest frequency playing surface and it examines the return ability of players as the balls bounce relatively high and lose a lot of initial velocity on contact with the water. Moreover, the number of matches for more than three times with same opponent are small in these two table, suggesting that the number of matches in head to head effect is relatively small even in ten years record.




```{r atp-surface,fig.width=10,fig.height=5,fig.cap="Matches with head to head effect on surface in ATP"}

#calculate the percentage of h2h matches in each surface for atp results
surface_count(atp_results,player0,player1,Surface)%>%
  group_by(Surface)%>%summarise(`match`=sum(n))%>%
  left_join(surface_count(atp_results,player0,player1,Surface)%>%
              filter(n==2)%>%group_by(Surface)%>%summarise(`match`=sum(n)),by=c('Surface'='Surface'))%>%
   left_join(surface_count(atp_results,player0,player1,Surface)%>%
              filter(n>=3)%>%group_by(Surface)%>%summarise(`match`=sum(n)),by=c('Surface'='Surface'))%>%
  rename(match=match.x,
         `match=2`=match.y,
         `match>=3`=match)%>%
  mutate(`per(match>=3)`=percent(`match>=3`/sum(`match>=3`)))->atp_surface

atp_surface_out = as.htmlwidget(formattable(atp_surface,
            list(`per(match>=3)` = color_bar("#BDD9EC"))))

atp_surface_out $dependencies = c(atp_surface_out $dependencies, htmlwidgets:::widget_dependencies("sparkline", "sparkline"))
atp_surface_out
```

```{r wta-surface,fig.cap="Matches with head to head effect on surface in WTA"}

#calculate the percentage of h2h matches in each surface for atp results
surface_count(wta_results,player0,player1,Surface)%>%
  group_by(Surface)%>%summarise(`match`=sum(n))%>%
  left_join(surface_count(wta_results,player0,player1,Surface)%>%
              filter(n==2)%>%group_by(Surface)%>%summarise(`match=2`=sum(n,na.rm=TRUE)),by=c('Surface'='Surface'))%>%
   left_join(surface_count(wta_results,player0,player1,Surface)%>%
              filter(n>=3)%>%group_by(Surface)%>%summarise(`match>=3`=sum(n,na.rm=TRUE)),by=c('Surface'='Surface'))->wta_surface
wta_surface[is.na(wta_surface)] = 0
wta_surface%>%
  mutate(`per(match>=3)`=percent(`match>=3`/sum(`match>=3`)))->wta_surface

wta_surface_out = as.htmlwidget(formattable(wta_surface,
            list(`per(match>=3)` = color_bar("#BDD9EC"))))
                # `per(match=2)` = color_bar("#FA614B") )))
wta_surface_out $dependencies = c(wta_surface_out $dependencies, htmlwidgets:::widget_dependencies("sparkline", "sparkline"))
wta_surface_out
```

In the following section, a variety of prediction methods will be introduced formally, and evaluated the estimates for parameters of the model and model performance.


# Modeling section

The main approaches to tennis match prediction in this project fall into two categories: simple pair comparison models and Bayesian Paired Comparison models in Stan. This section provides part of the technical description for models trained during this project.

## Pairwise Comparison Models

Pairwise comparison is the process of comparing entities in pairs to determine which one has a better chance of winning. One of the famous and more effective method for establishing pairwise comparison is Bradley Terry Model[@bradley1952rank], applying in the contest between two players in tennis[@mchale2011bradley].

Let $y_{ij,t}$ be the outcome of a tennis match that is played between player i and player j at time t. We assume that we have information about K different players over a time period of length n (i.e.: i, j =1.... ,K and t =1..., n). The outcome ${y_{ij,t} =1}$ if player i wins the match at time t whereas the outcome ${y_{ij,t} =0}$ if player j wins the match at time t. Therefore, the outcomes about $y_{ij,t}$ are binary response value.

The conditional probability that ${y_{ij,t} =1}$ is given by:
$$P_{ij,t}=P(y_{ij,t}=1|\delta_{ij,t})=\frac{exp(\delta_{ij,t})}{1+exp(\delta_{ij,t})};$$
$$\delta_{ij,t}=\lambda_{i,j}-\lambda_{j,t}$$
where$\lambda_{i,t}$ represents the skill level of player i at time t and $\lambda_{j,t}$ represents the skill level of player j at time t. The conditional probability of ${y_{ij,t} =0}$ is instead equal to $1-P_{ij,t}$.

On the other hand, this model can be alternatively expressed in the following logit-linear way, which can be reduce the model to logistics regression on pairs of individuals:
$$\mathrm{P}(\left[ i \mbox{ beats } j \right]=logit(P(i>j))=log(\frac{P(i>j)}{1-P(i>j)})=\lambda_{i}-\lambda_{j}$$
where $\lambda_{i}$=log$\alpha_{i}$ for all i and is the respective skill parameter of the players. Optimization can be used to jointly solve for skills parameters of all players based on a fixed period of historical results. Match winning probabilities can then be derived based on the same i.i.d(independent identifying distributed) assumption used in point models[@klaassen2001points]. Therefore, based on the IID assumption for all contests,the parameters $\lambda_{i}$ can be estimated by maximum likelihood using `BradleyTerry2` package for generalized linear models[@turner2012bradley]. 

The `BradleyTerry2` package provides a more flexible user interface to allow a wider range of models to be fitted in the data and allows the inclusion of simple random effects, where the $\lambda_{i}$ can be related to explanatory variable via a linear predictor of the form:
$$\lambda_{i}=\sum_{r=1}^{p}{\beta_{r}x_{ir}+U_{i}}$$

The inclusion of the prediction error $U_i$ allows for variability between players with equal covariate values and induces correlation between comparisons with a common player. 


## Bayesian Paired Comparison models in Stan

**1. Simple Bradley Terry model: **

Bayesian inferences are based on a posterior probability density distribution (further referred to as the posterior) regarding the parameters, given the data collected. This allows for a more intuitive interpretation of parameters uncertainty. Therefore, the Bayesian model can be broken down as consisting of:

* Observed variables: The tennis matches outcomes are given. A single outcome will be given the notation r and a set of outcomes D.

* prior probability: P(w). A standard normal prior is used in this project($w_{std} \sim N(0,1)$;$w \sim N(0,w_{std}^2)$)

The future outcomes can be predicted based on the relationship $P(r|w)$ if given the parameters of the model. However,since the parameters are unknown, the future value become inferred based on the historical data. For some data D, on a set of n outcomes, the posterior probability of the given model parameters can be expressed as:
$$P(w|D)=\frac{P(D|w)P(w)}{P(D)} \propto P(D|w)P(w)$$
where $P(D|w)$ is the likelihood of the model given the data and $P(D)$ is marginal likelihood of the model found through normalisation. Under the assumption that outcomes are independent identified distributed, the likelihood can be expressed as:
$$P(D|w)=\prod_{i = 1}^{N} P(r^i|w)$$ 

Moreover, for the prediction with new match $r^{n+1}$,it can be made by taking the expectation of $P(r^{n+1}|w)$ with respect to the posterior distribution $P(w|D)$. One of the common method to achieve the predicted value is used an approximate inference technique to approximate the full posterior distribution. In this case, it refers to Bayesian approach. 

Applying Bayesian method in Bradley Terry Model[@peterspredicting], the extension formula is shown as below:

$$\mathrm{P}(\left[ i \mbox{ beats } j \right])=P(r_{ij}=1|\lambda_{i},\lambda_{j})=\frac{exp(\lambda_{i})}{exp(\lambda_{i})+exp(\lambda_{j})}=\frac{1}{1+e^{-(\lambda_{i}-\lambda_{j})}}=\sigma(\lambda_{i}-\lambda_{j}) $$

where$r_{ij}=1$ indicates a win for player i against player j,$\lambda_{i}$ and $\lambda_{j}$ are the player skills which are the parameters of the model, and $\sigma$ is the logistic sigmoid function: $\frac{1}{1+e^{-x}}$. 

For the some of data consisting of a set of match outcomes $D={r^1,r^2...r^n}$ for a set of players $M ={1,2,...,m}$ with ability $\lambda={\lambda_{1},\lambda_{2},...,\lambda_{m}}$,the likelihood of the model given the data can be expressed as:
$$P(D|\lambda)=\prod_{i = 1}^{N} \sigma(\lambda_{a}^i-\lambda_{b}^i)$$ 

In this project, the $\lambda$ will be estimated as the prior probability with standard normal distribution ($\lambda_{std} \sim N(0,1)$;$\lambda \sim N(0,\lambda_{std}^2)$ and then added the observed match outcomes constantly to evaluate if the model strengthens or weakens the prior probability, so that the estimated posterior probability which will bet closer to actual value. After revising the posterior probabilities, the next match predictive outcome $P(r^{n+1}_{ij}=1|w)$ will be inferred as: $\sigma(\lambda_{i}-\lambda_{j})$ through posterior predictive distribution with Maximum a posteriori estimation(MAP) if given the previous matches data $r^n_{ij}$

**2. Mixed effect model in Stan (Surface random effect ): **

Böckenholt (2001)[@bockenholt2001hierarchical] decomposed the paired comparison model into fixed and a random effect components. The random effects component estimates the subject variation (given S subjects) in each item, while the fixed effect component such as $\lambda_{i,s}$ and $\lambda_{j,s}$ estimates the average log ability of the player. The random effects term is represented by $U_{i,s}$, where i refers to the player being judged and s to the subject. The Bayesian Bradley-Terry model with random effects can be represented as:
$$\mathrm{Pr}\left[ i \mbox{ beats } j \right]=\frac{exp(\lambda_{i,s})}{exp(\lambda_{i,s})+exp(\lambda_{j,s})};$$
$$\lambda_{i,s}=\lambda_{i}+U_{i,s};$$

$$y_{ij}\sim Bernoulli(\mathrm{P}\left[ i \mbox{ beats } j \right]);$$
$$ \lambda_{i} \sim N(0,\sigma_{\lambda}^2),[Prior];$$
$$ U_{i,s} \sim N(0,U_{std}^2),[Prior];$$
$$ U_{std} \sim N(0,\sigma_{U}^2),[Prior]$$

In this report, $s$ represents different types of surface so $U_{std}$ represents the standard deviation in the random effects and the difference between subjects. Therefore, the surface variable should be the random intercept as the grouped variables to evaluate the ability of each players within different surfaces. By doing this way, added the surface as a benchmark to represent the matches in which each pair players on different field. Moreover,the parameters $\lambda_{i}$ can be used to rank the different players. However, in the Bayesian framework, a single measure is not obtained but rather a posterior distribution of the parameters $\lambda_{i}$. By sampling from the posterior distribution of the log-abilities of the players, it is possible to create a posterior distribution of the ranks of the players, which helps to evaluate the uncertainty in the ranking system.


# Impelementation

This section discusses the implementation of three different prediction models and is structured as follows:
- Data re-preparation: briefly discusses the new model data about ranking data with top 100 players.
- Model process: mainly introduces the process of modeling in each prediction model. 
- Model output analysis: discusses the findings and results from the models.

## Data re-preparation

For avoiding the technical issue such as the system crush, overload and time consumption, a subset data with selecting top 100 players for ATP and WTA to build up the model efficiently instead of using the full datasets with ATP and WTA matches record. Therefore, `atp_ranking` and `wta_ranking` were collected from the official websites, atpworldtour.com and wtatennis.com respectively, with the rankings of the top 100 women and 100 men and they joined with the full dataset so the players were limited in the ranking of top 100 in both male and female for the final model data and it will be used for whole modeling parts.


```{r read-tennis-ranking}
library(rvest)
atp_html <- read_html(here::here("data/ATP_Tennis.html"))
atp_rankings <- html_node(atp_html, "table") %>% html_table(fill=TRUE) 
# There is only one table in page so use html_node rather than html_nodes
atp_rankings <- atp_rankings %>% 
  janitor::remove_empty() %>% 
  dplyr::as_tibble()



wta_html <- read_html(here::here("data/WTA_Tennis.html"))


wta_rankings <- html_node(wta_html, "table") %>% html_table(fill=TRUE) 
wta_rankings <- wta_rankings %>% 
  janitor::remove_empty() %>% 
  as_tibble()%>%
  select(RANK,PLAYER)
PLAYER<-c("Marta Kostyuk","Varvara Gracheva")
RANK<-c(80,89)
wta_rankings%>%
  head(98)%>%
  rbind(cbind(RANK,PLAYER))%>%
  mutate(RANK=as.numeric(RANK))%>%
  arrange(RANK)->wta_rankings
```

```{r subset-top-100-players}
atp_results%>%
 select(player0,player1,Surface,Player0,Player1) %>%  
  filter(player0%in%atp_rankings$Player & player1%in%atp_rankings$Player)->atp_top_100

wta_results%>%
 select(player0,player1,Surface,Player0,Player1) %>%  
  filter(player0%in%wta_rankings$PLAYER & player1%in%wta_rankings$PLAYER)->wta_top_100
h2h_count<-function(data,player0,player1){
  data%>%
    group_by(Player0, Player1) %>%
	dplyr::summarise(	n = n(),y = sum(Player0 == player0),.groups = "drop")
}

```

```{r construct-clean-datasets}
# tidy up new matches data and convert the two factors for players into same level in terms of building the model
h2h_count(atp_top_100,player0,player1)%>%
  rename(total_count=n,
         p0_count=y)%>%
  mutate(p1_count=total_count-p0_count,
          Player0 = factor(Player0, levels = unique(c(Player0, Player1))),
         Player1= factor(Player1, levels = levels(Player0)))->atp_match

h2h_count(wta_top_100,player0,player1)%>%
  rename(total_count=n,
         p0_count=y)%>%
  mutate(p1_count=total_count-p0_count,
          Player0 = factor(Player0, levels = unique(c(Player0, Player1))),
         Player1= factor(Player1, levels = levels(Player0)))->wta_match
```


## Bradley Terry Model Evaluation



```{r simple-BT-model}
#the coefficients are maximum likelihood estimates of lambda n with lambda1( the log-ability for Adrian Mannarino) set to zero as identifying convention

#~player specifies the model for player ability, in this case it stands for ‘tennis capability’ 

atp_bt<-BTm(cbind(p0_count,p1_count),Player0,Player1,~Player,id="Player",data=atp_match)
wta_bt<-BTm(cbind(p0_count,p1_count),Player0,Player1,~Player,id="Player",data=wta_match)

```

**Modeling process:**

The simple Bradley Terry Model is implemented by the `BradleyTerry2` package. There are two main functions used in this project:

- `BTm` function: constructs the Bradley Terry model with the matrix of p0_count and p1_count from the top 100 players data

- `BTabilities` function:  computes the ability of each player from the model objects against with the baseline player.

**Model output analysis:**

- Ability table interpretation:



```{r ATP-ability,fig.cap="The estimated ability of different tennis players in ATP"}
# construct the coefficient data frame and read the coeffienct in convenient way
atp_abilities <- BTabilities(atp_bt) # Matrix of ability and StdErr

atp_abilities <- data.frame(
  Player = rownames(atp_abilities),
  Ability = atp_abilities[,1],
  SE = atp_abilities[,2]
)

atp_abilities$Player <- factor(atp_abilities$Player, 
                        levels = atp_abilities$Player[order(atp_abilities$Ability)],
                        order = T)

atp_abilities%>%
  datatable(options = list(pageLength = 10,dom = 'Bt'),filter = 'top', caption = 'The estimated ability for ATP data')%>%
  formatRound(columns=c('Ability', 'SE'), digits=4)
```


```{r WTA-ability,fig.cap="The estimated ability of different tennis players in WTA"}
wta_abilities <- BTabilities(wta_bt) # Matrix of ability and StdErr

wta_abilities <- data.frame(
  Player = rownames(wta_abilities),
  Ability = wta_abilities[,1],
  SE = wta_abilities[,2]
)

wta_abilities$Player <- factor(wta_abilities$Player, 
                        levels = wta_abilities$Player[order(wta_abilities$Ability)],
                        order = T)
wta_abilities%>%
   datatable(options = list(pageLength = 10),filter = 'top', caption = 'The estimated ability for WTA data')%>%
   formatRound(columns=c('Ability', 'SE'), digits=4)
  
  # DT::datatable(options = list(pageLength = 10),filter = 'top', rownames = FALSE,caption = htmltools::tags$caption(
  #   style = 'caption-side: bottom; text-align: center;',
  #   'Table 2: ', htmltools::em('The estimated ability for WTA data')
  # ))
```

From the table \@ref(fig:ATP-ability) and \@ref(fig:WTA-ability), Adrian Mannarino and Ajla Tomljanovic became the baseline against with other players in the ATP and WTA data as their ability are 0. In the ATP data,Novak Djokovic,Rafael Nadal and Roger Federer have the highest estimated ability compared with the Adrian Mannarino. All three of them have played and won most of matches and their ranking almost maintain in the top 10 of the world on average, indicating that their tennis level are higher than other players. On the contrary, Lorenzo Musetti and Sebastian Korda have the lowest estimated ability and one of reason for that they have only played one game and even lost in that match,so their ability are estimated quite lower. 

Similarly, in the WTA model,Serena Williams have the highest estimated tennis skill whereas Clara Tauson have the lowest estimated tennis ability compared with Ajla. That could be caused by the fact that Serena won the most of matches like more than 50 matches based on the data and Clara only had played two matches but she lost both of them. 

### Bayesian Paired Comparison models in Stan

#### Bradley Terry model with head-to-head effect

**Modeling process:**

- `model_stan_data`:construct the stan model data with the total number of matches and the number of matches of player0 winning in each pair of players

- `bpc_h2h_pred.stan`: is the model script file. Instead of only using simple Bradley Terry model with bernoulli distribution in a single match,the Stan model data collapse the matches between every pair of players so it had been became the binomial distribution, which is structured as: $y \sim binomial(n,p)$. The main parameters are used in the Stan model:

  * n: is the N trials which is the total number of matches in each pair player.
  
  * y: is the number of success which is the number of times that player1 has won the match in this case. 
  
  
  * `lambda`: is the latent variable, representing the ability of a player and had estimated from standard normal distribution. 
  
  * $h2hz_{player_i,player_j}$: is a matrix which assigns the upper triangular values following standard normal distribution and lower triangular values following normal distribution but it has to be closer to zero which is the effective zero assignment.
  
  * $h2h_{player_i,player_j}$: is a matrix which assigns the upper triangular values using draws around a shared normal distribution. The lower triangular are the same effects of opposite sign. So basically there is a shared effect for player i, j but it adds or subtracts depending on the order of player and which player we are predicting the chance of a win for. 
  
  * `p1_win`: is the probability of player1 win with considering the head-to-head effects between each pair of player. In addition, based on the Bradley Terry Model, it has been used logistics function to evaluate the probability of player1 win($log_odd_players$) on the logit scale which is mapped $(0,1) \to R$, so the inverse logistics function should be used to transform the $log_odd_players$ to real probability of player1 win which is mapp $R \to (0,1)$ and the final structure for `p1_win` is shown as below:

$$Pr(player1\quad win)=\frac{e^{(\lambda_{player1}-\lambda_{player0}+h2h_{player1,player0})}}{1+e^{(\lambda_{player1}-\lambda_{player0}+h2h_{player1,player0})}}$$

  * `generated quantities`: created a new vector for predictive value via binomial distribution
  
- `vb` function: is used variational inference for finding optimal posterior distribution. In this case,using VB testing to examine the result whether the model construction and diagnostics is reasonable approximation or not. It can also minimize the difference between actual distribution and approximation distribution and reduce the time consumption, which is a more effective and less uncertain method for checking the Stan model correctly.

- `sampling` function: computes posterior samples via MCMC(Markov Chain Monte Carlo) method given a model previously compiled from `stan_model` (bpc_h2h_pred.stan). In this case, it is a more reliable way to find the posterior probability by final inferences.



```{r stan-data-function}
#set up the stan model data for atp and wta
make_stan_data <- function(data, win, n, player0, player1){
  
  players <- unique(c(data[[player0]], data[[player1]]))
  index <- order(players)
  names(index) <- players
  
  model_data  = list(
    index = index,
    y = data[[win]],
    n = data[[n]],
    player0_indexes = index[data$player0],
    player1_indexes = index[data$player1],
    N_total = nrow(data),
    N_players = max(index)
  )
}


atp_stan_data<-atp_match%>%
  rename(n=total_count,y=p1_count)%>%
  mutate(player0=as.character(Player0),
         player1=as.character(Player1))%>%
  select(player0,player1,n,y)

wta_stan_data<-wta_match%>%
  rename(n=total_count,y=p1_count)%>%
  mutate(player0=as.character(Player0),
         player1=as.character(Player1))%>%
  select(player0,player1,n,y)



```

```{r stan-model,eval=FALSE}

model_data_atp <- make_stan_data(atp_stan_data, "y", "n", "player0", "player1")
model_data_wta <- make_stan_data(wta_stan_data, "y", "n", "player0", "player1")

#compile the model
model <- rstan::stan_model("bpc_h2h_pred.stan")

# VB for model testing/development
atp_fit_model <- rstan::vb(model, 
                           data = model_data_atp,
                           tol_rel_obj = 0.001)
wta_fit_model <- rstan::vb(model, 
                           data = model_data_wta,
                           tol_rel_obj = 0.001)
# Use Sampling for final inference
atp_stan <- rstan::sampling(model, 
                           data = model_data_atp)
#saveRDS(wta_stan,"wta.rds")
wta_stan <- rstan::sampling(model, 
                           data = model_data_wta)

#construct the clean coefficient from the output of stan-model
atp_fit_summary <- summary(atp_stan)$summary %>% 
  as.data.frame() %>% 
  mutate(variable = rownames(.)) %>% 
  select(variable, everything()) %>% 
  as_data_frame()
#write_csv(atp_fit_summary,"atp_stan.csv")

wta_fit_summary <- summary(wta_stan)$summary %>% 
  as.data.frame() %>% 
  mutate(variable = rownames(.)) %>% 
  select(variable, everything()) %>% 
  as_data_frame()
#write_csv(wta_fit_summary,"wta_stan_fit.csv")
```

**Model output analysis:**

**1. MCMC Parameter diagnostics:**

By default the sampling method runs 4 Markov chains of Hamiltonian Monte Carlo in parallel, each of those chains proceeds with 1000 warmup iterations and 1000 sampling iterations, totaling 4000 sampling iterations available for diagnostics and analysis.

To examine the model fitting, the MCMC parameter diagnostics should be built up after extracting summary statistics on each model parameter.

- n_eff: the effective sample size
  - `n_eff` measures the effective sample size of that particular parameter which is the sum of the effectively independent sampling iterations across all chains(from a total 4000). The smaller `n_eff`, the greater the uncertainty associated with the corresponding parameter. If the ratio (`n_eff`/N) less than 0.001,indicating that the estimators are biased and significantly overestimate the true effective sample size(@gelman1992inference). Based on the figure \@ref(fig:check-neff),the distribution of ratio in two Stan models shows most of value are bigger than 0.5, suggesting that most of estimated parameter have better precision and there are no indications of problems in estimates of the effective sample size.
  
- Rhat: the potential scale reduction statistic
  - `Rhat` statistic is roughly the ratio of the variance of a parameter when the data is pooled across all of the chains to the within-chain variance so it can helps tell us whether these parameters are so poorly sampled and measures the extent to which chains are reaching different conclusions. The Rhat should be in the range of 0.9 to 1.05 as the more idiosyncratically the chains behave if the Rhat value is far away from 1 (@vehtari2021rank).  Figure \@ref(fig:check-rhat) displays the distribution of Rhat value in two Stan models and most of Rhat value are close to 1, implying that all chains have been converged to the same systematic behavior for a given parameter.
  
```{r check-neff,fig.cap="Evalute effective sample size in stan model"}

#constructed the summary statistics for atp or wta stan model
atp_fit<-read.csv(here("data/atp_stan.csv"))
wta_fit<-read.csv(here("data/wta_stan.csv"))

N<-4000
atp_neff_ratios<-atp_fit$n_eff/N
wta_neff_ratios<-wta_fit$n_eff/N

neff1<-mcmc_neff_hist(atp_neff_ratios,binwidth =0.1)+
  ggtitle("ATP stan model")

neff2<-mcmc_neff_hist(atp_neff_ratios,binwidth =0.1)+
ggtitle("WTA stan model")


ggarrange(neff1,neff2, common.legend = TRUE, legend="bottom",font.label = list(size=5,face="plain"))

```

```{r check-rhat,fig.cap="Evalute potential scale reduction statistic in stan model"}

atp_rhats<-atp_fit$Rhat
wta_rhats<-wta_fit$Rhat
rhat1<-mcmc_rhat_hist(atp_rhats,binwidth = 0.0005)+
  ggtitle("ATP stan model")

rhat2<-mcmc_rhat_hist(wta_rhats,binwidth = 0.0005)+
  ggtitle("WTA stan model")

ggarrange(rhat1,rhat2, common.legend = TRUE, legend="bottom",font.label = list(size=5,face="plain"))
```



**2.Head-to-head effect evaluation:** 

- H2H effect parameter distributions:

Figure \@ref(fig:check-h2h) represents the distribution of head-to-head effects are concentrated at 0 in two Stan models. The variation in h2h effects between the different players in the ATP model data was about 34%, which is higher than the variation with 17% in the WTA model data.

```{r check-h2h,fig.cap="The distribution of head-to-head effects in stan model"}
# check the h2h effect whether it is concentrated at 0
h2h1<-atp_fit %>% 
  filter(str_detect(variable,"h2h\\["))%>%
  summarise(mean=mean(mean),`2.5%`=mean(`X2.5.`),`97.5%`=mean(`X97.5.`),`25%`=mean(`X25.`),`75%`=mean(`X75.`))%>%
  mutate(variable=paste("h2h"))%>%
  ggplot() + 
  geom_linerange(aes(variable, ymin = `2.5%`,ymax = `97.5%`)) + 
  geom_crossbar(aes(variable, mean, ymin = `25%`, ymax = `75%`), fill= 'grey') +
  ggtitle("ATP stan model")


h2h2<-wta_fit %>% 
  filter(str_detect(variable,"h2h\\["))%>%
  summarise(mean=mean(mean),`2.5%`=mean(`X2.5.`),`97.5%`=mean(`X97.5.`),`25%`=mean(`X25.`),`75%`=mean(`X75.`))%>%
  mutate(variable=paste("h2h"))%>%
  ggplot() + 
  geom_linerange(aes(variable, ymin = `2.5%`,ymax = `97.5%`)) + 
  geom_crossbar(aes(variable, mean, ymin = `25%`, ymax = `75%`), fill= 'grey') +
    ggtitle("WTA stan model")

ggarrange(h2h1,h2h2,font.label = list(size=5,face="plain"))
```

- H2H effect in ATP data:



```{r h2h-atp,fig.cap="Head-to-head effect for each pair of players in ATP data"}
atp_players <- unique(c(atp_stan_data$player0, atp_stan_data$player1))
atp_index <- order(atp_players)
cbind(atp_players,atp_index)%>%
  as.data.frame()->atp_players
atp_stan_data%>%
  left_join(atp_players,by=c("player0"="atp_players"))%>%
  left_join(atp_players,by=c("player1"="atp_players"))%>%
  rename(player0_id=atp_index.x,
         player1_id=atp_index.y)->atp_stan_data

atp_fit%>%
  filter(str_detect(variable,"h2h\\["))%>%
  #filter(mean>0.1|mean<(-0.1))%>%
  arrange(desc(-mean))%>%
  separate(variable,c("h2h","id0","id1"))%>%
  select(id0,id1,mean)%>%
  left_join(atp_players,by=c("id0"="atp_index"))%>%
  left_join(atp_players,by=c("id1"="atp_index"))%>%
  rename(player0=atp_players.x,
         player1=atp_players.y)%>%
  left_join(atp_rankings%>%
              select(Ranking,Player),by=c("player0"="Player"))%>%
   left_join(atp_rankings%>%
              select(Ranking,Player),by=c("player1"="Player"))%>%
  rename(player0_rank=Ranking.x,
         player1_rank=Ranking.y)->atp_h2h


atp_h2h%>%
  filter(mean>0)%>%
  select(player0_rank,player1_rank,player0,player1,mean)%>%
  arrange(desc(mean))%>%
  datatable(options = list(pageLength = 10),filter = 'top',class = "table-hover table-striped cell-border stripe",caption = 'The head-to-head effect in different pair of players in ATP')%>%
  formatRound(columns=c('mean'), digits=4)

```

By filtering the negative mean value of h2h effects which is corresponded to a player(player1) who is disadvantaged or has lower win chance against with their opponent(player0), the table \@ref(fig:h2h-atp) shows the head-to-head effects in different pair and ranked players. The largest h2h effect is 0.26 between Dominic Thiem and David Goffin, where Dominic has lower win chance in their matches. In fact, These two have faced each other 9 times in their career with David leading 7 to 2 based on the historical data. However, Dominic is ranked higher than David and Elo rating shows that the point difference between these two players was over 100 with Dominic ahead which means implies that the favorite has a 64% chance of winning[@vaughan2021well]. It is surprisingly observed the result that David's advantage over Dominic is lopsided even though considering the player's ranking and Elo rating board. 

The another similar situation happened between Stan Wawrinka and Marin Cilic, who exist the second largest matchup effects. In the last ten years, Wawrinka has won all the matches when they have faced each other 7 times overall. It is worth noting that Wawrinka's ranking is higher than Cilic now but Cilic was surpassed Warinka in the ATP tour ranking in 2016,2017 and the difference was significant especially in 2018.

Generally speaking, the higher ranked players trend to have better level of tennis skills or more talented whereas they are also likely to suffer failure when facing specific opponents,like Gilles Simon against Gael Monfils, who are more than 50 places apart in the rankings and the h2h effect with 0.25 shows Gilles has got a 25% boost on his odds when facing Monfils. So it is not surprising that Gilles won 6 out of 8 matches with Monfils. 

On the other hand, there are also some interesting facts, for example Novak Djokovic and Daniil Medvedev are the world's No. 1 and No. 2 tennis players, but they have a greater chance to lose the match in the face of Nick Kyrgios and Lucas Pouille whose ranking is No.56 and No.85. Also,in the 100 biggest head-to-head effects,Lucas Pouille as the most frequently occurring in the beneficiary side of the player,having the benefit of the matchup class for 6 times, with the biggest edge being over Richard Gasquet. And Roberto Bautista Agut features 8 times in the top 100 overall, three of which were in the 10 biggest matchup effects. Roberto has disadvantaged with Fabio Fognini and Milos Raonic but had a better chance of winning when facing with Benoit Paire.

Federer and Rafael Nadal are widely regarded as the two greatest tennis players of all the time and the rivalry between them is considered as a modern-day tennis rivalry,also known as the famous Federer–Nadal rivalry [@bodo2010clay]. Even though the head-to-head effect between them gives 2% boost to Nadal which is not significant, it still can explain the some facts that Nadal won 9 of 16 matches over Federer and he had won 4 times over Federer in Clay in the 4 matches as well. Moreover, the Clay Elo rating of Nadal was higher than Federer in the last decay,implying that Nadal is more capable than Federer especially when the match takes place in Clay, which may explain the matchup effects. Moreover, Nadal have occurred 5 times as the disadvantaged players in the 100 biggest head-to-head effects,which is the most.  


- H2H effect in WTA data:



```{r h2h-wta,fig.cap="Head-to-head effect for each pair of players in WTA data"}
wta_players <- unique(c(wta_stan_data$player0, wta_stan_data$player1))
wta_index <- order(wta_players)
cbind(wta_players,wta_index)%>%
  as.data.frame()->wta_players
wta_stan_data%>%
  left_join(wta_players,by=c("player0"="wta_players"))%>%
  left_join(wta_players,by=c("player1"="wta_players"))%>%
  rename(player0_id=wta_index.x,
         player1_id=wta_index.y)->wta_stan_data

wta_fit%>%
  filter(str_detect(variable,"h2h\\["))%>%
  arrange(desc(-mean))%>%
  separate(variable,c("h2h","id0","id1"))%>%
  select(id0,id1,mean)%>%
  left_join(wta_players,by=c("id0"="wta_index"))%>%
  left_join(wta_players,by=c("id1"="wta_index"))%>%
  rename(player0=wta_players.x,
         player1=wta_players.y)%>%
  left_join(wta_rankings%>%
              select(RANK,PLAYER),by=c("player0"="PLAYER"))%>%
   left_join(wta_rankings%>%
              select(RANK,PLAYER),by=c("player1"="PLAYER"))%>%
  rename(player0_rank=RANK.x,
         player1_rank=RANK.y)->wta_h2h


wta_h2h%>%
  filter(mean>0)%>%
  select(player0_rank,player1_rank,player0,player1,mean)%>%
  arrange(desc(mean))%>%
  datatable(options = list(pageLength = 10),filter = 'top',caption = 'The head-to-head effect in different pair of players in WTA')%>%
   formatRound(columns=c('mean'), digits=4)
```


Table \@ref(fig:h2h-wta) represents the head-to-head effects between each pair of player from WTA model and the bigger the number, the more favorable for player0, that is, the greater the chance of winning the game. The biggest one is the match between Kirsten Flipkens	and Donna Vekic. They met five times between 2010 and 2020, and Flipkens won the match every time. Donna is higher than Flipkens in the player ranking and Elo rating system, while Flipkens is more favorable when matching with Donna, with 10% improvement on her win odds.

It is interesting to see several players occur multiple times in the top 10 matchup effects. Sloane Stephens,Heather Watson and Caroline Garcia all appear twice among the top 10 biggest head-to-head effects but only Caroline is favor in both sides. Moreover, Heather has the biggest advantage when facing with Stephens which won 4 time in the 6 matches and Misaki Doi is the next one who lost the matches all the time over Heather. Except for Heather, Stephens also has lower chance to win the matches over Johanna Konta. Based on the historical match records, Konta had won all four of their previous matches, all played in the last years. Only once did Stephens win the first games, in the Wimbledon in 2019, tooking the attack with slapping forehand winners cross-court,but Konta still won the match. 

Looking across all of the top 100 head-to-head effect, there are several players who seem to be candidates for clashes of game style with their competitors. Caroline has more potential opportunity to win over Victoria Azarenka and so it is the fact that Caroline always find the way to win the matches when meeting with Azarenke. However, the situation is completely different if Caroline faced with Barbora Strycova. In the last decay, Barbora and Caroline fought each other five times, but Caroline lost all the time. Their ranking look similar and one of reason is to explain that the clashes of games styles between them. Caroline is an offensive baseliner like Azarenka, with consistent and powerful ground strokes, whereas Barobora is an serve-and-volley player, with hitting the first and finishing volley to end the point. The point construction is serve, and it is difficult to return from which to hit a first volley so it may can explain why Caroline would have disadvantage over Barbora.

Another pair of player came out in the 10 biggest matchup effect is probably surprising even eager tennis fans. This head-to-head effect about Elina Svitolina	and Ashleigh Barty,where Elina has more advantageous. Barty is the most popular player in the world and her ranking is the first one now as well. But they met four times before 2020 and Barty lost all the matches. On the other hand, it was memorable that Naomi beats Serena in the chaotic 2018 US Open final and reached her fourth major title match. It is obviously that Naomi has the benefit of matchup effect over Serena from the table data, with 5% on her odds. Although the figure like the 5% improvement on odds is not significant, it can be explained to a certain extent that Naomi has the benefit of matchup effect with Serena.


#### Random effects in Bradley Terry model 

**Modeling process:**

- `bpc` function: is from the `bpcs` package which performs Bayesian estimation of Paired Comparison models utilizing Stan. There are three different surface types related to the matches so the `cluster` parameter should select in the surface column as the benchmarks for evaluating the ability of players in different surface. Once adding the random effect in the Bradley Terry model, the model type should become `bt-U`.

```{r random-effect-model,eval=FALSE}
atp_top_100%>%
  select(player0,player1,Surface)%>%
  mutate(y=as.numeric(0))->atp_top_surface

wta_top_100%>%select(player0,player1,Surface)%>%
  mutate(y=as.numeric(0))->wta_top_surface

atp_random <- bpc(data = atp_top_surface,
          player0 = 'player0',
          player1 = 'player1',
          result_column = 'y',
          model_type = 'bt-U',
         cluster = 'Surface',
          solve_ties = 'none', #there are no ties
          priors = list(prior_lambda_std = 2.0,prior_U1_std = 10.0),
            iter = 3000)

wta_random <- bpc(data = wta_top_surface,
          player0 = 'player0',
          player1 = 'player1',
          result_column = 'y',
          model_type = 'bt-U',
         cluster = 'Surface',
          solve_ties = 'none', 
            iter = 3000)

atp_random_no_prior <- bpc(data = atp_top_surface,
          player0 = 'player0',
          player1 = 'player1',
          result_column = 'y',
          model_type = 'bt-U',
         cluster = 'Surface',
          solve_ties = 'none',
            iter = 3000)
#write_csv(wta_random$hpdi,"wta_hpi.csv")
#write_csv(wta_random$lookup_table,"wta_lookup_table.csv")
#saveRDS(wta_random,"wta_random.rds")
```




```{r coefficient-atp-random}
#constructed the summary statstics of bpc function in atp data
atp_hpi<-read.csv(here("data/atp_hpi.csv"))
atp_lookup<-read.csv(here("data/atp_lookup.csv"))


# check the random effect coefficient with different players in hard surface
# the effect of a particular cluster in a particular team ability.

atp_lookup%>%
  left_join(atp_rankings%>%
              select(Player,Ranking),by=c("Names"="Player"))%>%
  right_join(atp_hpi%>%
  filter(str_detect(Parameter,"U1\\["))%>%
  separate(Parameter,c("U1","index","cluster"))%>%
    mutate(index=as.numeric(index))%>%
  filter(cluster=="1"),by=c("Index"="index"))%>%
  arrange(desc(Mean))%>%
  mutate(Surface=paste("Hard"))%>%
  select(Names,Ranking,Mean,Surface)->atp_hard

# check the random effect coefficient with different players in clay surface
atp_lookup%>%
  left_join(atp_rankings%>%
              select(Player,Ranking),by=c("Names"="Player"))%>%
  right_join(atp_hpi%>%
  filter(str_detect(Parameter,"U1\\["))%>%
  separate(Parameter,c("U1","index","cluster"))%>%
    mutate(index=as.numeric(index))%>%
  filter(cluster=="2"),by=c("Index"="index"))%>%
  arrange(desc(Mean))%>%
   mutate(Surface=paste("Clay"))%>%
  select(Names,Ranking,Mean,Surface)->atp_clay

# check the random effect coefficient with different players in grass surface
atp_lookup%>%
  left_join(atp_rankings%>%
              select(Player,Ranking),by=c("Names"="Player"))%>%
  right_join(atp_hpi%>%
  filter(str_detect(Parameter,"U1\\["))%>%
  separate(Parameter,c("U1","index","cluster"))%>%
    mutate(index=as.numeric(index))%>%
  filter(cluster=="3"),by=c("Index"="index"))%>%
  arrange(desc(Mean))%>%
  mutate(Surface=paste("Grass"))%>%
  select(Names,Ranking,Mean,Surface)->atp_grass
```

```{r coefficient-wta-random}

wta_hpi<-read.csv(here("data/wta_hpi.csv"))
wta_lookup<-read.csv(here("data/wta_lookup.csv"))

wta_lookup%>%
  left_join(wta_rankings%>%
              select(PLAYER,RANK),by=c("Names"="PLAYER"))%>%
  rename(Ranking=RANK)%>%
  right_join(wta_hpi%>%
  filter(str_detect(Parameter,"U1\\["))%>%
  separate(Parameter,c("U1","index","cluster"))%>%
    mutate(index=as.numeric(index))%>%
  filter(cluster=="1"),by=c("Index"="index"))%>%
  arrange(desc(Mean))%>%
  mutate(Surface=paste("Hard"))%>%
  select(Names,Ranking,Mean,Surface)->wta_hard

wta_lookup%>%
  left_join(wta_rankings%>%
              select(PLAYER,RANK),by=c("Names"="PLAYER"))%>%
  rename(Ranking=RANK)%>%
  right_join(wta_hpi%>%
  filter(str_detect(Parameter,"U1\\["))%>%
  separate(Parameter,c("U1","index","cluster"))%>%
    mutate(index=as.numeric(index))%>%
  filter(cluster=="2"),by=c("Index"="index"))%>%
  arrange(desc(Mean))%>%
   mutate(Surface=paste("Clay"))%>%
  select(Names,Ranking,Mean,Surface)->wta_clay

wta_lookup%>%
  left_join(wta_rankings%>%
             select(PLAYER,RANK),by=c("Names"="PLAYER"))%>%
  rename(Ranking=RANK)%>%
  right_join(wta_hpi%>%
  filter(str_detect(Parameter,"U1\\["))%>%
  separate(Parameter,c("U1","index","cluster"))%>%
    mutate(index=as.numeric(index))%>%
  filter(cluster=="3"),by=c("Index"="index"))%>%
  arrange(desc(Mean))%>%
  mutate(Surface=paste("Grass"))%>%
  select(Names,Ranking,Mean,Surface)->wta_grass
```

**Model output analysis:**

1. Ability table with different surface in ATP data :

```{r ability-atp-surface,fig.cap="The most higest estimated ability of ATP players in different surface" }
atp_hard%>%head(10)%>%rbind(atp_clay%>%head(10))%>%
 rbind(atp_grass%>%head(10))%>%
  mutate(Surface=as.factor(Surface))%>%
datatable(options =list(pageLength=10,autoWidth=FALSE),filter = 'top',caption = "The most higest estimated ability of ATP players in different surface" )%>%
  formatRound(columns=c('Mean'), digits=4)
```

From the table \@ref(fig:ability-atp-surface),it shows the most highest estimated ability of different players in the particular surface. It is not surprising to see that the estimated ability for Daniil Medvedev is the highest in the Hard court. As the matchup effect table has been shown before, Daniil Medvedev is in the fourth spot who has more potential chance to win over Stefanos Tsitsipas. Looking back the past macth records, Daniil won all four matches in the Hard,which can be reflected that Daniil has advanced tennis skilss in the Hard court. In terms of the estimated players' ability to play, Dominic Thiem	is the highest in the Clay court. Although the head-to-head effect between Dominic and David Goffin is the highest in overall where Dominic would at a disadvantage, Dominic still won 2 matches in the Clay court. Nadal is in the third place in the Clay court and it is not even unexpected at all. One of example can be explained for that is Nadal-Federer rivalry which has been discussed above. For the grass court, the estimated ability for Marin Cilic is the highest. In fact, the grass court favours a serve and volley style of play and Marin is exactly this type of player who serving moves quickly towards the net after hitting a serve or produce an effective returning volley in quick movement. 



2. Ability table with different surface in WTA data :


```{r ability-wta-surface,fig.cap="The most higest estimated ability of WTA players in different surface" }
wta_hard%>%head(10)%>%rbind(wta_clay%>%head(10))%>%
 rbind(wta_grass%>%head(10))%>%
  mutate(Surface=as.factor(Surface))%>%
datatable(options =list(pageLength=10,autoWidth=FALSE),filter = 'top',caption = "The most higest estimated ability of ATP players in different surface" )%>%
  formatRound(columns=c('Mean'), digits=4)
```



Anastasia has the most advanced tennis ability in the hard court based on the table \@ref(fig:ability-wta-surface). Since Anastasia has played 125 games, almost the most on hard court, and won more than half, Anastasia's ability should be higher. It is worth noting that Naomi and Sabalenka are in the fifth and eighth spot as well,both of them are the top 10 players in the world. In terms of the estimated players' ability to play, Tamara Zidansek is the highest in the clay court. Although Tamara claimed the first title on the pro-level in 2014, she did not have many match records in the model data but it is not hard to evaluate for that Tamara met with other 14 players in the 19 matches and won 15 times among them,indicating that Tamara has advantage in the clay court. Similarly, Kristina Mladenovic	is in the second spot of the top 10 players who has the most advanced skills in the clay court. Kristina won 25 out of 32 matches base on the past records, showing her better performance when playing in the clay court. It is interesting to see the estimated ability in the grass court for Alison Riske is greater than 1, and is also the highest among all players. In fact, Alison played 30 matched in total and won 22 times,so the probability of Alinson win is around 73%,the highest of all players. Barbora Strycova is in the second place in the list, winning 17 of 27 matches with a 63% chance. 



# Model Evaluation

After modeling the data, the predicted probability with each match will generate from different models. In addition,this project focuses on making probabilistic predictions on the overall outcome of each match. The predictions therefore take the form of a single value $P_{w}$, which is the probability assigned by a given model to the winning player. Since there are no draws and the probability of the losing player can be inferred as $P_{l}=1-P_{w}$, then a single value suffices for all predictions. For evaluating the model performances such as the model predictions are close to actual value or not, one of key method is the calibration. 

Calibration is a measure of the model performance which can be defined as how well the forecasted probabilities correspond to the actual outcomes and can be useful in order to better understand the behaviour and biases of different models[@kovalchik2016searching]. Basically, the probabilistic prediction can be well calibrated if the observed winning probability is close to $\alpha$ when considering all matches with predicted probabilities $\alpha$. In order to identify if this condition is satisfied, the calibration curve is established. Firstly,data will be grouped into 10 bins ordered by their predicted probability, 0-10%, 10-20%, etc and the mean of predicted probability will be calculated in each bin. And then the mean of predicted probability will be compared with the mean of actual probability in each bin which is sum of the matches of players win divided by the sum of the number of matches between each pair players played.

When a model is well-calibrated, the mean of actual probability against with mean of predicted probability will close with each other. If the mean of actual probability is greater than the mean of predicted probability, the models trend to be underestimate the wins of players, the reverse is overestimate.


## Bradley Terry Model

In the Bradley Terry model, using the `predict` function to predictive winning probability of player 0 in the competition between each pair of players, and then grouping the expected probability into 10 bins to calculated the mean of expected probability in each bins. Table \@ref(tab:cali-bt-table) shows the comparison between the mean of actual probability and the mean of predictive probability in each bin in ATP and WTA. The larger the positive difference is, the greater the underestimation of the winning rate is. At the same time, the larger the negative difference is, the more overestimated the winning rate is. In order to directly visualize the difference between expected value against with actuality, the scatterplot \@ref(fig:cali-bt-plot) is constructed as the calibration curve to evaluate the model performance.

Therefore, from the figure \@ref(fig:cali-bt-plot), the estimated winning probability of player 0 is close to actual value especially in the range of 0.5 to 0.75 in ATP data. There is a little bit of volatility outside the range. Looking back in the table, it is obvious that the difference between expected value against with reality is smaller and positive except in the bins 2,3,5 and 9. The biggest differences is in the bins 2 and it can be visualized in the plot as well where has the most fluctuating in the 12%-15%.

A similar way to access the model performance in WTA data. The closest to real probability is in the fourth to ninth bins where all differences are almost after second decimal places. It is interesting to see there is a turning point after 84% which is the biggest difference as well compared with others,is 0,0786 in the tenth bin. The reason for that is the mean of actual probability is 1 which all the player 0 won all the matches in the tenth bin but expected probabilities for them are around 0.92, it may cause the winning probabilities of player 0 will be underestimated in the tenth bin. 

Although there are differences in each box, the difference is small and can be ignored. Moreover, most of the predicted values in the scatter plot \@ref(fig:cali-bt-plot) fit well with the actual probability. Overall, the model prediction is close to actual winning probability of player 0. 

```{r cali-bt-table,fig.cap="Calibration table with Bradley Terry Model"}
atp_match%>%
  cbind(predict(atp_bt,type="response")%>%
  as_tibble())%>%
  rename(y_pred=value)%>%
  mutate(prob_p0=p0_count/total_count)->atp_bt_pred
wta_match%>%
  cbind(predict(wta_bt,type="response")%>%
  as_tibble())%>%
  rename(y_pred=value)%>%
  mutate(prob_p0=p0_count/total_count)->wta_bt_pred

bins<-function(data){
  data%>%
  mutate(bins=as.numeric(case_when(y_pred<=0.1~1,
                                     y_pred<=0.2&y_pred>0.1~2,
                                     y_pred<=0.3&y_pred>0.2~3,
                                     y_pred<=0.4&y_pred>0.3~4,
                                     y_pred<=0.5&y_pred>0.4~5,
                                     y_pred<=0.6&y_pred>0.5~6,
                                     y_pred<=0.7&y_pred>0.6~7,
                                     y_pred<=0.8&y_pred>0.7~8,
                                     y_pred<=0.9&y_pred>0.8~9,
                                     y_pred<=1&y_pred>0.9~10)))
}

bin_freq<-function(data){
  data%>%
  group_by(bins)%>%
  summarise(pred_prob=sum(y_pred))%>%
  left_join(data%>%
              group_by(bins)%>%
              tally())%>%
  mutate(mean_pred=pred_prob/n)%>%
  select(bins,mean_pred)%>%
    ungroup()
}

bins(atp_bt_pred)->atp_bt_bins
bin_freq(atp_bt_bins)->atp_bt_freq


atp_bt_bins%>%
  group_by(bins)%>%
  summarise(mean_act=sum(p0_count)/sum(total_count))%>%
  ungroup()%>%
  left_join(atp_bt_freq)->atp_bt_cali

bins(wta_bt_pred)->wta_bt_bins
bin_freq(wta_bt_bins)->wta_bt_freq

wta_bt_bins%>%
  group_by(bins)%>%
  summarise(mean_act=sum(p0_count)/sum(total_count))%>%
  ungroup()%>%
  left_join(wta_bt_freq)->wta_bt_cali


atp_bt_cali%>%
  rename(atp_mean_act=mean_act,
         atp_mean_pred=mean_pred)%>%
  left_join(wta_bt_cali%>%
  rename(wta_mean_act=mean_act,
         wta_mean_pred=mean_pred),by=c("bins"="bins"))%>%
  mutate(atp_diff=atp_mean_act-atp_mean_pred,
         wta_diff=wta_mean_act-wta_mean_pred)%>%
  kable(caption = "Calibration table for Bradley Terry model",digits = 4) %>%
  kable_styling(bootstrap_options = 
                  c("striped", "condensed"), 
                  full_width = T, 
                  position = "center")
```


```{r cali-bt-plot,fig.cap="Calibration curve in Bradley Terry Model"}

p1<-ggplot(atp_bt_cali,aes(mean_pred,mean_act))+
  geom_line()+
  geom_abline(slope = 1, intercept = 0, linetype = 2) +
  coord_cartesian(xlim = c(0, 1), ylim = c(0, 1)) +
  theme_bw()+
  xlab("Estimated probability")+ylab("Actual probability")+
  ggtitle("ATP data")

p2<-ggplot(wta_bt_cali,aes(mean_act,mean_pred))+
  geom_line()+
  geom_abline(slope = 1, intercept = 0, linetype = 2) +
  coord_cartesian(xlim = c(0, 1), ylim = c(0, 1)) +
  theme_bw()+
  xlab("Estimated probability")+ylab("Actual probability")+
  ggtitle("WTA data")
ggarrange(p1,p2)
```


## Bayesian paired comparison model

### Head-to-head effect

Since the Stan model used the binomial distribution as the predictive model,the predicted value from the head-to-head effect with bayesian paired comparison model is no longer be probability,but the number of matches player 1 wins. And, the predicted value should be an integer because of the definition of binomial distribution, so it is reasonable to choose the prediction with 50% as the final prediction of the match that player 1 will win.

It is clear that there are two segments of the WTA data with the greatest volatility in the figure \@ref(fig:cali-stan-plot), one trends to be concave, the other one be convex. The fluctuation in ATP data seems to be lesser than WTA data and only the first and last bins deviated from 45 degree line, and the rest seemed to fit well. 

Rather than only visualizing the relationship between expected probability and actual probability from the figure, combine with the table \@ref(tab:cali-stan-table) to analyze why such a situation appears. Based on the table \@ref(tab:cali-stan-table), the most interesting thing for WTA data is in the last two bins where the mean of actual probability is 1 in the ninth bin and the mean of predicted probability is 1 in the tenth bin,causing the convex issue. In fact, in the ninth bin, only one pair player like Victoria Azarenka with Alize Cornet appears and Azarenka won the matches all the time but the predicted matches of Azarenka win are 5, which causes the difference between mean of actual probability and expected value. However, there are several pair of players that the number predicted matches of player 1 win higher than actual matches in the tenth bins,the difference are 2 and the head-to-head effect are concentrated at 0.066,indicating that the matchup effects among them are unstable. Moreover, the ranking of all the player 1 are higher than player 0 and it implies the ability of player 1 are higher than player 0, which may cause the predicted matches of player 1 would be higher than actual. A similar situation happened in the tenth bin in ATP data, all of head-to-head effect are concentrated on 0.14 and the ranking of all player 1 are higher than player 0,suggesting that the matchup effects between them are irregular or variable.

Another point of concern is that the mean predicted probability are zero in both first bins. One of reason is that the number matches between each pair player are almost less than two,in other words, there are more than 100 pairs player who have only met one time with their opponent,indicating that head-to-head effects between them are less than other because of the sample size are smaller so all the predicted matches of player 1 win are zero in this case.

In general, the model performance with considering head-to-head effect is better in terms of ATP data rather than WTA data.


```{r cali-stan-table,fig.cap="Calibration table for evaluating head-to-head effect"}
atp_stan_data%>%
  select(player0,player1,n,y)%>%
  rename(p1_count=y,total_count=n)%>%
  cbind(atp_fit%>%
  filter(str_detect(variable,"y_pred"))%>%
  select(X50.)%>%
    rename(p1_pred=X50.))%>%
    mutate(y_pred=p1_pred/total_count)->atp_stan_pred

bins(atp_stan_pred)->atp_stan_bins

bin_freq(atp_stan_bins)->atp_stan_freq

atp_stan_freq%>%
  left_join(atp_stan_bins%>%
  group_by(bins)%>%
  summarise(mean_act=sum(p1_count)/sum(total_count)))->atp_stan_cali

wta_stan_data%>%
  select(player0,player1,n,y)%>%
  rename(p1_count=y,total_count=n)%>%
  cbind(wta_fit%>%
  filter(str_detect(variable,"y_pred"))%>%
  select(X50.)%>%
    rename(p1_pred=X50.))%>%
    mutate(y_pred=p1_pred/total_count)->wta_stan_pred

bins(wta_stan_pred)->wta_stan_bins

bin_freq(wta_stan_bins)->wta_stan_freq

wta_stan_freq%>%
  left_join(wta_stan_bins%>%
  group_by(bins)%>%
  summarise(mean_act=sum(p1_count)/sum(total_count)))->wta_stan_cali

atp_stan_cali%>%
  rename(atp_mean_act=mean_act,
         atp_mean_pred=mean_pred)%>%
  left_join(wta_stan_cali%>%
  rename(wta_mean_act=mean_act,
         wta_mean_pred=mean_pred),by=c("bins"="bins"))%>%
  mutate(atp_diff=atp_mean_act-atp_mean_pred,
         wta_diff=wta_mean_act-wta_mean_pred)%>%
  kable(caption = "Calibration table for evaluating head-to-head effect",digits = 4) %>%
  kable_styling(bootstrap_options = 
                  c("striped", "condensed"), 
                  full_width = T, 
                  position = "center")
```


```{r cali-stan-plot,fig.cap="Calibration curve in head-to-head effect Stan model"}
p3<-ggplot(atp_stan_cali,aes(mean_pred,mean_act))+
  geom_line()+
  geom_abline(slope = 1, intercept = 0, linetype = 2) +
  coord_cartesian(xlim = c(0, 1), ylim = c(0, 1)) +
  theme_bw()+
  xlab("Estimated probability")+ylab("Actual probability")+
  ggtitle("ATP data")

p4<-ggplot(wta_stan_cali,aes(mean_act,mean_pred))+
  geom_line()+
  geom_abline(slope = 1, intercept = 0, linetype = 2) +
  coord_cartesian(xlim = c(0, 1), ylim = c(0, 1)) +
  theme_bw()+
  xlab("Estimated probability")+ylab("Actual probability")+
  ggtitle("WTA data")
ggarrange(p3,p4)
```

### Random effect in bayesian paired comparison model

```{r surface-data}

atp_top_100%>%
  group_by(Player0, Player1,Surface) %>%
	dplyr::summarise(	n = n(),y = sum(Player0 == player0),.groups = "drop")->atp_sf
wta_top_100%>%
  group_by(Player0, Player1,Surface) %>%
	dplyr::summarise(	n = n(),y = sum(Player0 == player0),.groups = "drop")->wta_sf
```

```{r surface-predicted-value,eval=FALSE}

y_pp <- posterior_predictive(atp_random)
y <- y_pp$y%>%
  as_tibble()
yrep <- y_pp$y_pred%>%
  as_tibble()
new_atp<-atp_top_surface%>%
  dplyr::select(player0,player1,Surface)

predict(atp_random,type="response",newdata = new_atp)%>%
  as_tibble()->atp_pred
cbind(new_atp,colMeans(dplyr::select(df, starts_with('y_pred')))%>%
  as_tibble())->atp_surface_pred
#write_csv(atp_surface_pred,"atp_surface_pred.csv")

new_wta<-wta_surface%>%
  dplyr::select(player0,player1,Surface)
predict(wta_random,type="response",newdata = new_wta)%>%
  as_tibble()->wta_pred
cbind(new_wta,colMeans(dplyr::select(df, starts_with('y_pred')))%>%
  as_tibble())->wta_surface_pred
#write_csv(wta_surface_pred,"wta_surface_pred.csv")
```