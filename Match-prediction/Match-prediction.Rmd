---
title: "Predicting match results in professional tennis"
author:
- familyname: HE
  othernames: XITONG
  address: Monash University
  email: xhee0013@student.monash.edu
  correspondingauthor: true
  qualifications: 29026342
department: Department of\newline Econometrics &\newline Business Statistics
organization: ETC5543 Internship Project
bibliography: references.bib
biblio-style: authoryear-comp
linestretch: 1.5
output:
  MonashEBSTemplates::report:
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    includes:
      in_header: preamble.tex
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, messages=FALSE, warning=FALSE)

library(tidyverse)
library(dplyr)
library(ggplot2)
library(here)
```


```{r read-data}
atp_results<-readRDS(here("data/atp_results.rds"))
wta_results<-readRDS(here("data/wta_results.rds"))
```

# Abstract

This project examines several probabilistic models for forecasting the outcomes of professional tennis levels such as ATP or WTA matches. These models not only focus on the prediction results in the tennis matched, but also consider the head to head effect where would affect the performance in some players. In addition, the effects of surface type and the variation of player skills would be addressed in the models as one of the exploratory variables. The models are trained and evaluated on the two historical tennis matches results of approximately 38,000 tennis matches between 2010 and 2020. 

# Data description {#data}

This section mainly introduces the data, data sources and data description.   

There are two data sets used on this analysis report, and both of them are obtained from [GitHub skoval](https://github.com/skoval/monash-match-wins), which have similar data structures.  


## ATP_results

The `atp_results` data source is from [Github skoval](https://github.com/skoval/monash-match-wins). The data contains the ATP tour results in the last decay, which is a worldwide top-tier tennis tour for men organized by the Association of Tennis Professionals, with `r nrow(atp_results)` observations and `r ncol(atp_results)`variables from 2011-01-01 to 2020-01-23.   

The variables information included in the data are shown as the following table, Players, Surface,MatchID and Tier variables were mainly used for this analysis.    

```{r atp-data, warning=FALSE, message=FALSE}
atp_data <- data.frame(
  Variable = c("ID1","ID2","ID_T","ID_R","RESULT","DATE","NAME_T","DATE_T","Surface","Player1","Player2","Retired","Walkover","Qualifying","MatchID","Tier"),
  Description = c("Winner ID", "Loser ID","Terminology ID","The around in tennis match","Matches games results","Match Date","Name of the match","Date of tennis tourments","Match Surface","Match Winner","Match Loser","withdrawal of a player during a match, usually due to injury and illness","victory awarded to a player when their opponent concedes a match before it begins, usually due to injury or illness","preliminary event that offers players whose rankings don’t gain them direct entry in the main draw of a tournament, the opportunity to win a spot in that main draw","Unique ID for each match","collective term referring to the group of matches or rubbers played between two teams in a team tennis even"
  ))

atp_data %>%
  kable(caption = "Association of Tennis Professionals") %>%
  kable_styling(bootstrap_options = 
                c("striped", "condensed"), 
                full_width = F, 
                position = "center")
```


 
## WTA data

The `wta_results`data was gathered from [Github skoval](https://github.com/skoval/monash-match-wins) as well, of which is recorded the worldwide professional tennis tour match results for women. This dataset contains `r nrow(wta_results)` observation and `r ncol(wta_results)` variables from 2011-01-01 to 2020-01-23 and the data structure is shown as the below tables: 

```{r wta-data, warning=FALSE, message=FALSE}
wta_data <- data.frame(
  Variable = c("ID1","ID2","ID_T","ID_R","RESULT","DATE","NAME_T","DATE_T","Surface","Player1","Player2","Retired","Walkover","Qualifying","MatchID","Tier"),
  Description = c("Winner ID", "Loser ID","Terminology ID","The around in tennis match","Matches games results","Match Date","Name of the match","Date of tennis tourments","Match Surface","Match Winner","Match Loser","withdrawal of a player during a match, usually due to injury and illness","victory awarded to a player when their opponent concedes a match before it begins, usually due to injury or illness","preliminary event that offers players whose rankings don’t gain them direct entry in the main draw of a tournament, the opportunity to win a spot in that main draw","Unique ID for each match","collective term referring to the group of matches or rubbers played between two teams in a team tennis even"
  ))

wta_data %>%
  kable(caption = "Women’s Tennis Association Tour") %>%
  kable_styling(bootstrap_options = 
                c("striped", "condensed"), 
                full_width = F, 
                position = "center")
```


# Head to Head effect Analysis

## Evaluating the head to head effect in each tier

(explore the percentage of occurring head to head matches in different three tiers )

```{r tier_summary,fig.cap="Matches of head to head effect on each tier"}

#calculate the percentage of h2h matches in each tier for atp results

atp_results%>%
  group_by(Player1,Player2,Tier)%>%
  count()%>%
  group_by(Tier)%>%
  summarise(n=sum(n))%>%
  ungroup->atp_tier
atp_tier


atp_tier_summary<-atp_tier%>%
  mutate(total=sum(n),
         `prop`=n/total,
         per=percent(prop))

out = as.htmlwidget(formattable(atp_tier_summary,
            list(`per` = color_bar("#FA614B"))))
out$dependencies = c(out$dependencies, htmlwidgets:::widget_dependencies("sparkline", "sparkline"))
out
  
```

## Evaluating the H2H effect in each surface

(explore the percentage of occurring head to head matches in different three tiers )

```{r surface_summary,fig.cap="Matches of head to head effect on three types of surface"}

#calculate the percentage of h2h matches in each surface for atp results

atp_results%>%
  group_by(Player1,Player2,Surface)%>%
  count()%>%
  group_by(Surface)%>%
  summarise(n=sum(n))%>%
  ungroup->atp_surface


atp_surface_summary<-atp_surface%>%
  mutate(total=sum(n),
         `prop`=n/total,
         per=percent(prop))

out = as.htmlwidget(formattable(atp_surface_summary,
            list(`per` = color_bar("#FA614B"))))
out$dependencies = c(out$dependencies, htmlwidgets:::widget_dependencies("sparkline", "sparkline"))
out
```


## Calculating the head to head effect on win odds for each matches

(summarize the total matches of each pair players, and calculating the winners odd who has won most of matches between two players)


```{r long-format-matches}
# tidy up the data(rename and select variables)
atp_results%>%
  filter(Retired!="TRUE",Walkover!="TRUE")%>%
  rename(Winner_ID=ID1,Loser_ID=ID2,Winner=Player1,Loser=Player2)%>%
  select(Winner_ID,Loser_ID,Winner,Loser,Surface,Tier)->atp_matches
atp_matches$h2hid<-paste0(atp_matches$Winner_ID, 
                      ':', atp_matches$Loser_ID )
atp_matches$matches<-paste0(atp_matches$Winner, 
                      ':', atp_matches$Loser)

# Make long format by stacking winners and losers
atp_long <- rbind(
	atp_results %>% filter(Retired!="TRUE",Walkover!="TRUE")%>% dplyr::select(playerid = ID1, opponentid = ID2, ID_T, ID_R, DATE, Surface, player = Player1, MatchID, Tier) %>% dplyr::mutate(matchwin = TRUE),
	atp_results %>% filter(Retired!="TRUE",Walkover!="TRUE")%>%
	  dplyr::select(playerid = ID2, opponentid = ID1, ID_T, ID_R, DATE, Surface, player = Player2, MatchID, Tier) %>% dplyr::mutate(matchwin = FALSE)
)

head_to_head <- function(id1, id2){
	# assign h2h idea 
	ifelse(id1 > id2, paste(id1, id2, sep = ":"), paste(id2, id1, sep = ":"))
}

atp_long <- atp_long %>%
	dplyr::mutate(
		h2hid = head_to_head(playerid, opponentid)
	)
```


```{r calculating the prob}
atp_h2h_match<-atp_matches%>%
  group_by(h2hid,Winner,Loser)%>%
  tally()%>%
  ungroup(h2hid)

#use the atp_long data set to calculate the total number of each pair players where they met
atp_h2h_count<-atp_long%>%
  group_by(h2hid)%>%
  tally()%>%
  mutate(total_count=n/2)%>%
  select(-n)%>%
  ungroup()

#calculate the win probability and lose probability for each pair players in terms of total number of the matches
match_count<-left_join(atp_h2h_match,atp_h2h_count,by="h2hid")%>%
  drop_na()%>%#drop na since some of data are included in the total matches of each pair palyers but only different in winning players
  rename(p1_count=n)%>%
  mutate(p2_count=round(total_count-p1_count,3),
         prob_p1_win=round(p1_count/total_count,3),
         prob_p2_win=round(p2_count/total_count,3))
```






