---
title: "bpc_draft"
author: "XITONG HE(29026342)"
date: "16/05/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE,warning = FALSE)
```

```{r}
library(tidyverse)
library(bpcs)
library(rstan)
library(rvest)
library(here)

```


# Data section

```{r read-tennis-data}
atp_results <- readRDS(here::here("data/atp_results.rds"))%>%
  filter(Retired!="TRUE",Walkover!="TRUE")

atp_results%>%
  select(Player1,Player2)%>%
  rename(player0=Player1,player1=Player2)%>%
  mutate(y=as.numeric(0))->atp_results

wta_results <- readRDS(here::here("data/wta_results.rds"))%>%
  filter(Retired!="TRUE",Walkover!="TRUE")

wta_results%>%
  select(Player1,Player2)%>%
  rename(player0=Player1,player1=Player2)%>%
  mutate(y=as.numeric(0))->wta_results
```


```{r read-tennis-ranking}
atp_html <- read_html(here::here("data/ATP_Tennis.html"))
atp_rankings <- html_node(atp_html, "table") %>% html_table(fill=TRUE) 
# There is only one table in page so use html_node rather than html_nodes
atp_rankings <- atp_rankings %>% 
  janitor::remove_empty() %>% 
  dplyr::as_tibble()
atp_rankings


wta_html <- read_html(here::here("data/WTA_Tennis.html"))


wta_rankings <- html_node(wta_html, "table") %>% html_table(fill=TRUE) 
wta_rankings <- wta_rankings %>% 
  janitor::remove_empty() %>% 
  as_tibble()%>%
  head(100)
wta_rankings


```

```{r top-100-tennis-players}
atp_results%>%
  filter(player0%in%atp_rankings$Player&player1%in%atp_rankings$Player)->atp_top_100

wta_results%>%
  filter(player0%in%wta_rankings$PLAYER&player1%in%wta_rankings$PLAYER)->wta_top_100
```

# Model section

```{r stan-data-function}
make_stan_data <- function(data, win, player0, player1){
  
  players <- unique(c(data[,player0], data[,player1]))
  index <- order(players)
  names(index) <- players
  
  model_data  = list(
    index = index,
    y = data[,win],
    player0_indexes = index[data$player0],
    player1_indexes = index[data$player1],
    N_total = nrow(data),
    N_players = max(index)
  )
}


model_data_atp <- make_stan_data(atp_top_100, "y", "player0", "player1")
model_data_wta <- make_stan_data(wta_top_100, "y", "player0", "player1")

model <- rstan::stan_model("bpc_h2h.stan")
```


```{r stan-model,eval=FALSE}
# Use VB for testing
atp_fit_model <- rstan::vb(model, 
                           data = model_data_atp,
                           tol_rel_obj = 0.001)

# Use Sampling for testing
atp_fit <- rstan::sampling(model, 
                           data = model_data_atp)


wta_fit_model <- rstan::vb(model, 
                           data = model_data_wta,
                           tol_rel_obj = 0.001)
wta_fit <- rstan::sampling(model, 
                           data = model_data_wta)


```


```{r coefficient-stan-model,eval=FALSE}

h2h<-summary(atp_fit, pars = "h2h")$summary%>%
  as.data.frame()%>%
  rownames_to_column(var = "h2h")

atp_fit_summary <- summary(atp_fit)$summary %>% 
  as.data.frame() %>% 
  mutate(variable = rownames(.)) %>% 
  select(variable, everything()) %>% 
  as_data_frame()
# write_csv(atp_fit_summary,"atp_sampling.csv")

#VB model

# h2h_model<-summary(fit_model, pars = "h2h")$summary%>%
#   as.data.frame()%>%
#   rownames_to_column(var = "h2h")


wta_fit_summary <- summary(wta_fit)$summary %>% 
  as.data.frame() %>% 
  mutate(variable = rownames(.)) %>% 
  select(variable, everything()) %>% 
  as_data_frame()
# write_csv(wta_fit_summary,"wta_sampling.csv")

wta_h2h<-summary(wta_fit, pars = "h2h")$summary%>%
  as.data.frame()%>%
  rownames_to_column(var = "h2h")
```


# Parameter diagnostics

```{r check-diagnostics}
atp_fit<-read.csv(here("data/atp_sampling.csv"))
wta_fit<-read.csv(here("data/wta_sampling.csv"))

atp_fit %>% 
  ggplot(aes(n_eff)) + 
  geom_histogram(bins = 30) + 
  geom_vline(aes(xintercept = 4000), color = 'red')

wta_fit %>% 
  ggplot(aes(n_eff)) + 
  geom_histogram(bins = 30) + 
  geom_vline(aes(xintercept = 4000), color = 'red')

atp_fit %>% 
  ggplot(aes(Rhat)) + 
  geom_histogram(bins=6) + 
  geom_vline(aes(xintercept = 1.05), color = 'red')+
  geom_vline(aes(xintercept = 0.9), color = 'red')

wta_fit %>% 
  ggplot(aes(Rhat)) + 
  geom_histogram(bins=6) + 
  geom_vline(aes(xintercept = 1.05), color = 'red')+
    geom_vline(aes(xintercept = 0.9), color = 'red')

# check the h2h effect whether it is concentrated at 0
atp_fit %>% 
  filter(str_detect(variable,"h2h\\["))%>%
  summarise(mean=mean(mean),`2.5%`=mean(`X2.5.`),`97.5%`=mean(`X97.5.`),`25%`=mean(`X25.`),`75%`=mean(`X75.`))%>%
  mutate(variable=paste("h2h"))%>%
  ggplot() + 
  geom_linerange(aes(variable, ymin = `2.5%`,ymax = `97.5%`)) + 
  geom_crossbar(aes(variable, mean, ymin = `25%`, ymax = `75%`), fill= 'grey') 


wta_fit %>% 
  filter(str_detect(variable,"h2h\\["))%>%
  summarise(mean=mean(mean),`2.5%`=mean(`X2.5.`),`97.5%`=mean(`X97.5.`),`25%`=mean(`X25.`),`75%`=mean(`X75.`))%>%
  mutate(variable=paste("h2h"))%>%
  ggplot() + 
  geom_linerange(aes(variable, ymin = `2.5%`,ymax = `97.5%`)) + 
  geom_crossbar(aes(variable, mean, ymin = `25%`, ymax = `75%`), fill= 'grey') 

```

Extract summary statistics on each model parameter:

1. n_eff: the effective sample size
  *`n_eff` measures the effective sample size of that particular parameter which is the sum of the effectively independent sampling iterations across all chains. The smaller `n_eff`, the greater the uncertainty associated with the corresponding parameter. In this case, There are 4 chains, with 2000 iterations, half of which are warmup, meaning it has sampled 1000 iterations in each chain, so the max n_eff possible in this case is 4000. Based on the summary with `atp_fit` and `wta_fit`, most of parameters have a fairly high n_eff value,indicating that most of estimated parameter have better precision.
  
2. Rhat: the potential scale reduction statistic
  *`Rhat` statistic is roughly the ratio of the variance of a parameter when the data is pooled across all of the chains to the within-chain variance so it can helps tell us whether these parameters are so poorly sampled and measures the extent to which chains are reaching different conclusions. Gelman recommends that Rhat should be less than 1.05 and greater than 0.9 for the parameters of interest. In this case, all the Rhat values of the estimated parameters in `atp_fit` and `wta_fit` are converged into the range.
  
3. H2H effect parameters 

  *Based on the boxplot in the `atp_fit` and `wta_fit`, the h2h effects are concentrated at 0. The variation in h2h effects between the different players in the `atp_fit` was about 34%, which is higher than the variation with 14% in the `wta_fit`.

