---
title: "bpc_draft"
author: "XITONG HE(29026342)"
date: "16/05/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE,warning = FALSE)
```

```{r}
library(tidyverse)
library(bpcs)
library(rstan)
library(rvest)
library(here)

```


# Data section

```{r read-tennis-data}
atp_results <- readRDS(here::here("data/atp_results.rds"))%>%
  filter(Retired!="TRUE",Walkover!="TRUE")

atp_results%>%
  select(Player1,Player2,Surface)%>%
  rename(player0=Player1,player1=Player2)%>%
  mutate(y=as.numeric(0))->atp_results

wta_results <- readRDS(here::here("data/wta_results.rds"))%>%
  filter(Retired!="TRUE",Walkover!="TRUE")

wta_results%>%
  select(Player1,Player2,Surface)%>%
  rename(player0=Player1,player1=Player2)%>%
  mutate(y=as.numeric(0))->wta_results
```


```{r read-tennis-ranking}
atp_html <- read_html(here::here("data/ATP_Tennis.html"))
atp_rankings <- html_node(atp_html, "table") %>% html_table(fill=TRUE) 
# There is only one table in page so use html_node rather than html_nodes
atp_rankings <- atp_rankings %>% 
  janitor::remove_empty() %>% 
  dplyr::as_tibble()
atp_rankings


wta_html <- read_html(here::here("data/WTA_Tennis.html"))


wta_rankings <- html_node(wta_html, "table") %>% html_table(fill=TRUE) 
wta_rankings <- wta_rankings %>% 
  janitor::remove_empty() %>% 
  as_tibble()%>%
  head(100)
wta_rankings


```

```{r top-100-tennis-players}
atp_results%>%
  filter(player0%in%atp_rankings$Player&player1%in%atp_rankings$Player)%>%
  select(player0,player1,y)->atp_top_100

wta_results%>%
  filter(player0%in%wta_rankings$PLAYER&player1%in%wta_rankings$PLAYER)%>%
  select(player0,player1,y)->wta_top_100
```

# Model section

```{r stan-data-function}
make_stan_data <- function(data, win, player0, player1){
  
  players <- unique(c(data[,player0], data[,player1]))
  index <- order(players)
  names(index) <- players
  
  model_data  = list(
    index = index,
    y = data[,win],
    player0_indexes = index[data$player0],
    player1_indexes = index[data$player1],
    N_total = nrow(data),
    N_players = max(index)
  )
}


model_data_atp <- make_stan_data(atp_top_100, "y", "player0", "player1")
model_data_wta <- make_stan_data(wta_top_100, "y", "player0", "player1")

model <- rstan::stan_model("bpc_h2h.stan")
```


```{r stan-model,eval=FALSE}
# Use VB for testing
atp_fit_model <- rstan::vb(model, 
                           data = model_data_atp,
                           tol_rel_obj = 0.001)

# Use Sampling for testing
atp_fit <- rstan::sampling(model, 
                           data = model_data_atp)


wta_fit_model <- rstan::vb(model, 
                           data = model_data_wta,
                           tol_rel_obj = 0.001)
wta_fit <- rstan::sampling(model, 
                           data = model_data_wta)


```


```{r coefficient-stan-model,eval=FALSE}

h2h<-summary(atp_fit, pars = "h2h")$summary%>%
  as.data.frame()%>%
  rownames_to_column(var = "h2h")

atp_fit_summary <- summary(atp_fit)$summary %>% 
  as.data.frame() %>% 
  mutate(variable = rownames(.)) %>% 
  select(variable, everything()) %>% 
  as_data_frame()
# write_csv(atp_fit_summary,"atp_sampling.csv")

#VB model

# h2h_model<-summary(fit_model, pars = "h2h")$summary%>%
#   as.data.frame()%>%
#   rownames_to_column(var = "h2h")


wta_fit_summary <- summary(wta_fit)$summary %>% 
  as.data.frame() %>% 
  mutate(variable = rownames(.)) %>% 
  select(variable, everything()) %>% 
  as_data_frame()
# write_csv(wta_fit_summary,"wta_sampling.csv")

wta_h2h<-summary(wta_fit, pars = "h2h")$summary%>%
  as.data.frame()%>%
  rownames_to_column(var = "h2h")
```


# Parameter diagnostics

```{r check-diagnostics}

#constructed the summary statistics for atp or wta stan model
atp_fit<-read.csv(here("data/atp_sampling.csv"))
wta_fit<-read.csv(here("data/wta_sampling.csv"))

atp_fit %>% 
  ggplot(aes(n_eff)) + 
  geom_histogram(bins = 30) + 
  geom_vline(aes(xintercept = 4000), color = 'red')

wta_fit %>% 
  ggplot(aes(n_eff)) + 
  geom_histogram(bins = 30) + 
  geom_vline(aes(xintercept = 4000), color = 'red')

atp_fit %>% 
  ggplot(aes(Rhat)) + 
  geom_histogram(bins=6) + 
  geom_vline(aes(xintercept = 1.05), color = 'red')+
  geom_vline(aes(xintercept = 0.9), color = 'red')

wta_fit %>% 
  ggplot(aes(Rhat)) + 
  geom_histogram(bins=6) + 
  geom_vline(aes(xintercept = 1.05), color = 'red')+
    geom_vline(aes(xintercept = 0.9), color = 'red')

# check the h2h effect whether it is concentrated at 0
atp_fit %>% 
  filter(str_detect(variable,"h2h\\["))%>%
  summarise(mean=mean(mean),`2.5%`=mean(`X2.5.`),`97.5%`=mean(`X97.5.`),`25%`=mean(`X25.`),`75%`=mean(`X75.`))%>%
  mutate(variable=paste("h2h"))%>%
  ggplot() + 
  geom_linerange(aes(variable, ymin = `2.5%`,ymax = `97.5%`)) + 
  geom_crossbar(aes(variable, mean, ymin = `25%`, ymax = `75%`), fill= 'grey') 


wta_fit %>% 
  filter(str_detect(variable,"h2h\\["))%>%
  summarise(mean=mean(mean),`2.5%`=mean(`X2.5.`),`97.5%`=mean(`X97.5.`),`25%`=mean(`X25.`),`75%`=mean(`X75.`))%>%
  mutate(variable=paste("h2h"))%>%
  ggplot() + 
  geom_linerange(aes(variable, ymin = `2.5%`,ymax = `97.5%`)) + 
  geom_crossbar(aes(variable, mean, ymin = `25%`, ymax = `75%`), fill= 'grey') 

```

Extract summary statistics on each model parameter:

1. n_eff: the effective sample size
  *`n_eff` measures the effective sample size of that particular parameter which is the sum of the effectively independent sampling iterations across all chains. The smaller `n_eff`, the greater the uncertainty associated with the corresponding parameter. In this case, There are 4 chains, with 2000 iterations, half of which are warmup, meaning it has sampled 1000 iterations in each chain, so the max n_eff possible in this case is 4000. Based on the summary with `atp_fit` and `wta_fit`, most of parameters have a fairly high n_eff value,indicating that most of estimated parameter have better precision.
  
2. Rhat: the potential scale reduction statistic
  *`Rhat` statistic is roughly the ratio of the variance of a parameter when the data is pooled across all of the chains to the within-chain variance so it can helps tell us whether these parameters are so poorly sampled and measures the extent to which chains are reaching different conclusions. Gelman recommends that Rhat should be less than 1.05 and greater than 0.9 for the parameters of interest. In this case, all the Rhat values of the estimated parameters in `atp_fit` and `wta_fit` are converged into the range.
  
3. H2H effect parameters 

  *Based on the boxplot in the `atp_fit` and `wta_fit`, the h2h effects are concentrated at 0. The variation in h2h effects between the different players in the `atp_fit` was about 34%, which is higher than the variation with 14% in the `wta_fit`.
  
# Evaluating h2h effect 

```{r h2h-atp}
atp_players <- unique(c(atp_top_100$player0, atp_top_100$player1))
atp_index <- order(atp_players)
cbind(atp_players,atp_index)%>%
  as.data.frame()->atp_players
atp_top_100%>%
  left_join(atp_players,by=c("player0"="atp_players"))%>%
  left_join(atp_players,by=c("player1"="atp_players"))%>%
  rename(player0_id=atp_index.x,
         player1_id=atp_index.y)->atp_top_100

atp_fit%>%
  filter(str_detect(variable,"h2h\\["))%>%
  #filter(mean>0.1|mean<(-0.1))%>%
  arrange(desc(-mean))%>%
  separate(variable,c("h2h","id0","id1"))%>%
  select(id0,id1,mean)%>%
  left_join(atp_players,by=c("id0"="atp_index"))%>%
  left_join(atp_players,by=c("id1"="atp_index"))%>%
  rename(player0=atp_players.x,
         player1=atp_players.y)%>%
  left_join(atp_rankings%>%
              select(Ranking,Player),by=c("player0"="Player"))%>%
   left_join(atp_rankings%>%
              select(Ranking,Player),by=c("player1"="Player"))%>%
  rename(player0_rank=Ranking.x,
         player1_rank=Ranking.y)->atp_h2h
atp_h2h%>%
  filter(player0_rank<player1_rank&mean<0)%>%
  select(player0_rank,player1_rank,player0,player1,mean)%>%
  #arrange(desc(-mean))%>%
  # kableExtra::kable(caption = "The h2h effect for players with lower win chances ") %>%
  # kableExtra::kable_styling(bootstrap_options = c("striped", "condensed"), 
  #               full_width = T, 
  #               position = "center")%>%
  DT::datatable(options = list(pageLength = 10),filter = 'top')
  
```

From the table above in the `atp_fit`, by filtering the negative mean value of h2h effects which is corresponded to a player who is disadvantaged (lower win chance) than their ability, and the rank of player0s is lower than player1s, it could evaluate the head-to-head effects between higher ranked players and lower ranked players. The largest negative is -0.27 between Dominic Thiem and David Goffin, where Dominic has lower win chance in their matches. On the other hand, there are also some interesting facts, for example Novak Djokovic and Daniil Medvedev are the world's No. 1 and No. 2 tennis players, but they have a greater chance to lose the match in the face of Nick Kyrgios and Lucas Pouille. Generally speaking, the higher ranked players have a better level of tennis skill or more talented whereas they are also likely to suffer failure when facing specific opponents,like Dominic Thiem against Kevin Anderson, who are more than 90 places apart in the rankings and the h2h effect with -0.177 shows Dominic has disadvantage with Kevin. It is obviously that Roberto Bautista Agut, Adrian Mannarino,Jeremy Chardy and Borna Coric have all appeared twice in the top 10 head-to-head effects, with Jeremy being the only person to be favored whereas Roberto being the only one to be disadvantage in both cases.

```{r h2h-wta}
wta_players <- unique(c(wta_top_100$player0, wta_top_100$player1))
wta_index <- order(wta_players)
cbind(wta_players,wta_index)%>%
  as.data.frame()->wta_players
wta_top_100%>%
  left_join(wta_players,by=c("player0"="wta_players"))%>%
  left_join(wta_players,by=c("player1"="wta_players"))%>%
  rename(player0_id=wta_index.x,
         player1_id=wta_index.y)->wta_top_100

wta_fit%>%
  filter(str_detect(variable,"h2h\\["))%>%
  #filter(mean>0.1|mean<(-0.1))%>%
  arrange(desc(-mean))%>%
  separate(variable,c("h2h","id0","id1"))%>%
  select(id0,id1,mean)%>%
  left_join(wta_players,by=c("id0"="wta_index"))%>%
  left_join(wta_players,by=c("id1"="wta_index"))%>%
  rename(player0=wta_players.x,
         player1=wta_players.y)%>%
  left_join(wta_rankings%>%
              select(RANK,PLAYER),by=c("player0"="PLAYER"))%>%
   left_join(wta_rankings%>%
              select(RANK,PLAYER),by=c("player1"="PLAYER"))%>%
  rename(player0_rank=RANK.x,
         player1_rank=RANK.y)->wta_h2h
wta_h2h%>%
  filter(player0_rank<player1_rank&mean<0)%>%
  select(player0_rank,player1_rank,player0,player1,mean)%>%
  #mutate(diff=player0_rank-player1_rank)%>%
  arrange(desc(-mean))%>%
  DT::datatable(options = list(pageLength = 10),filter = 'top')
```

Compared with `atp_fit`, the smallest estimated values of h2h effects in the `wta_fit` is -0.0867 which is not quite lower. In the first 10 pair of players, the rank difference between Petra Kvitova and Madison Brengle is the largest and the estimated h2h effect is only -0.072, suggesting Petra Kvitova has lower chances to win Madison. Also, it is interesting to see several players occurr multiple times in the top 10 matchup effects. Barbora Strycova and Heather Watson occurred twice among the 10 biggest head-to-head effects while Caroline Garcia occurred three times. Moreover, Barbora with her head-to-head over Caroline or Johanna Konta, and Heather with her head-to-head over Sloane Stephens or Caroline are the only two players to be favoured. Another things to be noticed that Caroline was disadvantage with Barbora and Heather but she has higher probability to win Victoria Azarenka whose rank is higher.

# Random effect with surface

```{r surface-data}
atp_results%>%
  filter(player0%in%atp_rankings$Player&player1%in%atp_rankings$Player)->atp_surface
wta_results%>%
  filter(player0%in%wta_rankings$PLAYER&player1%in%wta_rankings$PLAYER)->wta_surface
```

```{r random-effect-model,eval=FALSE}
atp_random <- bpc(data = atp_surface,
          player0 = 'player0',
          player1 = 'player1',
          result_column = 'y',
          model_type = 'bt-U',
         cluster = 'Surface',
          solve_ties = 'none', #there are no ties
          priors = list(prior_lambda_std = 2.0,prior_U1_std = 10.0),
            iter = 3000)

wta_random <- bpc(data = wta_surface,
          player0 = 'player0',
          player1 = 'player1',
          result_column = 'y',
          model_type = 'bt-U',
         cluster = 'Surface',
          solve_ties = 'none', #there are no ties
          priors = list(prior_lambda_std = 2.0,prior_U1_std = 10.0),
            iter = 3000)
# write_csv(atp_random$hpdi,"atp_hpi.csv")
# write_csv(atp_random$lookup_table,"atp_lookup_table.csv")
```


```{r coefficient-atp-random}
#constructed the summary statstics of bpc function in atp data
atp_hpi<-read.csv(here("data/atp_hpi.csv"))
atp_lookup<-read.csv(here("data/atp_lookup_table.csv"))



# check the ability of each players
# A higher lambda indicates a higher team ability
atp_lookup%>%
  left_join(atp_rankings%>%
              select(Player,Ranking),by=c("Names"="Player"))%>%
  right_join(atp_hpi%>%
  filter(str_detect(Parameter,"lambda"))%>%
  separate(Parameter,c("lambda","index"))%>%
    mutate(index=as.numeric(index)),by=c("Index"="index"))%>%
  arrange(desc(Mean))


# check the random effect coefficient with different players in hard surface
# the effect of a particular cluster in a particular team ability.

atp_lookup%>%
  left_join(atp_rankings%>%
              select(Player,Ranking),by=c("Names"="Player"))%>%
  right_join(atp_hpi%>%
  filter(str_detect(Parameter,"U1\\["))%>%
  separate(Parameter,c("U1","index","cluster"))%>%
    mutate(index=as.numeric(index))%>%
  filter(cluster=="1"),by=c("Index"="index"))%>%
  arrange(desc(Mean))

# check the random effect coefficient with different players in clay surface
atp_lookup%>%
  left_join(atp_rankings%>%
              select(Player,Ranking),by=c("Names"="Player"))%>%
  right_join(atp_hpi%>%
  filter(str_detect(Parameter,"U1\\["))%>%
  separate(Parameter,c("U1","index","cluster"))%>%
    mutate(index=as.numeric(index))%>%
  filter(cluster=="2"),by=c("Index"="index"))%>%
  arrange(desc(Mean))

# check the random effect coefficient with different players in grass surface
atp_lookup%>%
  left_join(atp_rankings%>%
              select(Player,Ranking),by=c("Names"="Player"))%>%
  right_join(atp_hpi%>%
  filter(str_detect(Parameter,"U1\\["))%>%
  separate(Parameter,c("U1","index","cluster"))%>%
    mutate(index=as.numeric(index))%>%
  filter(cluster=="3"),by=c("Index"="index"))%>%
  arrange(desc(Mean))
```


From the outputs above,it shows the ability of different players and the effect of the particular surface for player's ability. Thus, Novak Djokovic, Rafael Nadal and Roger Federer have the highest lambda value,indicating that these three players have the advanced the tennis skills compared the rest of players. Instead of only evaluating the ability of different players,the random effect with surface type are included in the model for analyzing the effect of different surface types for a player's ability. So there are three clusters such as cluster 1, cluster 2 and cluster 3, representing the hard, clay,and grass surface. In general, Daniil Medvedev has the best tennis ability in the hard court and Dominic Thiem has more advantage in the clay court whereas Marin Cilic is better playing at grass court.